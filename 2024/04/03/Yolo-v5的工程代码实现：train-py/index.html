

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600;700;900&display=swap" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/logo.png">
  <link rel="icon" href="/img/logo.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Yang Zhou">
  <meta name="keywords" content="">
  
    <meta name="description" content="Yolo v5的训练代码解读与debug。">
<meta property="og:type" content="article">
<meta property="og:title" content="Yolo v5的工程代码实现：train.py">
<meta property="og:url" content="http://example.com/2024/04/03/Yolo-v5%E7%9A%84%E5%B7%A5%E7%A8%8B%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0%EF%BC%9Atrain-py/index.html">
<meta property="og:site_name" content="我不是算法工程师">
<meta property="og:description" content="Yolo v5的训练代码解读与debug。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://images.zerolovesea.top/blog/yolov5.png">
<meta property="article:published_time" content="2024-04-03T14:01:28.000Z">
<meta property="article:modified_time" content="2025-05-28T13:49:03.610Z">
<meta property="article:author" content="Yang Zhou">
<meta property="article:tag" content="CV">
<meta property="article:tag" content="工程实践">
<meta property="article:tag" content="Yolo">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://images.zerolovesea.top/blog/yolov5.png">
  
  
  
  <title>Yolo v5的工程代码实现：train.py - 我不是算法工程师</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/custom.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":60,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"left","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"wHpSTH8j8vF1pDJWJtnFXbzc-gzGzoHsz","app_key":"L2ZYyCM9mJIfR5Nxm7ktn3tU","server_url":"https://whpsth8j.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>我不是工程师</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/databases/" target="_self">
                <i class="iconfont icon-books"></i>
                <span>书单</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/quote/" target="_self">
                <i class="iconfont icon-pen"></i>
                <span>写给自己</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/168691.webp') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Yolo v5的工程代码实现：train.py"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-04-03 22:01" pubdate>
          2024年4月3日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          9.4k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          79 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="padding-left: 2rem; margin-right: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Yolo v5的工程代码实现：train.py</h1>
            
            
              <div class="markdown-body">
                
                <p>距离上次解读Yolo v5的工程代码又过了一段时间，这次继续debug一下它的<code>train.py</code>。</p>
<h1 id="导入依赖库"><a href="#导入依赖库" class="headerlink" title="导入依赖库"></a>导入依赖库</h1><p>首先就是大段的依赖导入各种库：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> argparse       <span class="hljs-comment"># 解析命令行参数模块</span><br><span class="hljs-keyword">import</span> math           <span class="hljs-comment"># 数学公式模块</span><br><span class="hljs-keyword">import</span> os             <span class="hljs-comment"># 与操作系统进行交互的模块 包含文件路径操作和解析</span><br><span class="hljs-keyword">import</span> random         <span class="hljs-comment"># 生成随机数的模块</span><br><span class="hljs-keyword">import</span> sys            <span class="hljs-comment"># sys系统模块 包含了与Python解释器和它的环境有关的函数</span><br><span class="hljs-keyword">import</span> time           <span class="hljs-comment"># 时间模块 更底层</span><br><span class="hljs-keyword">from</span> copy <span class="hljs-keyword">import</span> deepcopy <span class="hljs-comment"># 深拷贝模块</span><br><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime <span class="hljs-comment"># 基本日期和时间类型模块</span><br><span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path <span class="hljs-comment"># Path模块将str转换为Path对象 使字符串路径易于操作</span><br><span class="hljs-keyword">import</span> subprocess     <span class="hljs-comment"># 命令行模块</span><br><br><span class="hljs-keyword">try</span>:<br>    <span class="hljs-keyword">import</span> comet_ml  <span class="hljs-comment"># must be imported before torch (if installed)</span><br><span class="hljs-keyword">except</span> ImportError:<br>    comet_ml = <span class="hljs-literal">None</span><br><br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torch.distributed <span class="hljs-keyword">as</span> dist<br><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn<br><span class="hljs-keyword">import</span> yaml<br><span class="hljs-keyword">from</span> torch.optim <span class="hljs-keyword">import</span> lr_scheduler <span class="hljs-comment"># 学习率模块</span><br><span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> tqdm<br></code></pre></td></tr></table></figure>
<p>这里的<code>deepcopy</code>区别于平时的<code>=</code>进行赋值，不同在于，<code>=</code>只是把对象的内存地址拷贝，最终引用的还是原来的同一个对象。而深拷贝则是完完全全把内容复制成一个新的对象。此时修改这个新对象，不会把老对象的内容改变。</p>
<p>接下来导入自定义模块：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 获取当前文件的绝对路径，使用Path库将其转换为Path对象</span><br>FILE = Path(__file__).resolve()<br>ROOT = FILE.parents[<span class="hljs-number">0</span>]  <span class="hljs-comment"># YOLOv5的根目录，例如D://yolov5</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span>(ROOT) <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> sys.path:<br>    sys.path.append(<span class="hljs-built_in">str</span>(ROOT))  <span class="hljs-comment"># add ROOT to PATH</span><br>ROOT = Path(os.path.relpath(ROOT, Path.cwd()))  <span class="hljs-comment"># relative</span><br><br><span class="hljs-keyword">import</span> val <span class="hljs-keyword">as</span> validate  <span class="hljs-comment"># for end-of-epoch mAP</span><br><span class="hljs-keyword">from</span> models.experimental <span class="hljs-keyword">import</span> attempt_load <span class="hljs-comment"># 实验性的代码</span><br><span class="hljs-keyword">from</span> models.yolo <span class="hljs-keyword">import</span> Model <span class="hljs-comment"># yolo模型</span><br><span class="hljs-keyword">from</span> utils.autoanchor <span class="hljs-keyword">import</span> check_anchors <span class="hljs-comment"># 定义自动锚框生成的方法</span><br><span class="hljs-keyword">from</span> utils.autobatch <span class="hljs-keyword">import</span> check_train_batch_size <span class="hljs-comment"># 定义自动生成批次大小的方法</span><br><span class="hljs-keyword">from</span> utils.callbacks <span class="hljs-keyword">import</span> Callbacks <span class="hljs-comment"># 为日志服务的回调函数</span><br><span class="hljs-keyword">from</span> utils.dataloaders <span class="hljs-keyword">import</span> create_dataloader <br><span class="hljs-keyword">from</span> utils.downloads <span class="hljs-keyword">import</span> attempt_download, is_url<br><span class="hljs-keyword">from</span> utils.general <span class="hljs-keyword">import</span> (<br>    LOGGER,<br>    TQDM_BAR_FORMAT,<br>    check_amp,<br>    check_dataset,<br>    check_file,<br>    check_git_info,<br>    check_git_status,<br>    check_img_size,<br>    check_requirements,<br>    check_suffix,<br>    check_yaml,<br>    colorstr,<br>    get_latest_run,<br>    increment_path,<br>    init_seeds,<br>    intersect_dicts,<br>    labels_to_class_weights,<br>    labels_to_image_weights,<br>    methods,<br>    one_cycle,<br>    print_args,<br>    print_mutation,<br>    strip_optimizer,<br>    yaml_save,<br>)<br><span class="hljs-keyword">from</span> utils.loggers <span class="hljs-keyword">import</span> LOGGERS, Loggers<br><span class="hljs-keyword">from</span> utils.loggers.comet.comet_utils <span class="hljs-keyword">import</span> check_comet_resume<br><span class="hljs-keyword">from</span> utils.loss <span class="hljs-keyword">import</span> ComputeLoss<br><span class="hljs-keyword">from</span> utils.metrics <span class="hljs-keyword">import</span> fitness<br><span class="hljs-keyword">from</span> utils.plots <span class="hljs-keyword">import</span> plot_evolve <span class="hljs-comment"># 定义了Annotator类，可以在图像上绘制矩形框和标注信息</span><br><span class="hljs-keyword">from</span> utils.torch_utils <span class="hljs-keyword">import</span> (<br>    EarlyStopping,<br>    ModelEMA,<br>    de_parallel,<br>    select_device,<br>    smart_DDP,<br>    smart_optimizer,<br>    smart_resume,<br>    torch_distributed_zero_first,<br>)<br></code></pre></td></tr></table></figure>

<h1 id="分布式训练初始化"><a href="#分布式训练初始化" class="headerlink" title="分布式训练初始化"></a>分布式训练初始化</h1><p>导包完成后，需要配置一些分布式训练的参数，分别是Local Rank, Rank和World Size。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">LOCAL_RANK = <span class="hljs-built_in">int</span>(os.getenv(<span class="hljs-string">&quot;LOCAL_RANK&quot;</span>, -<span class="hljs-number">1</span>))  <span class="hljs-comment"># 当前Worker 是这台机器上的第几个 Worker：当前进程对应的GPU</span><br>RANK = <span class="hljs-built_in">int</span>(os.getenv(<span class="hljs-string">&quot;RANK&quot;</span>, -<span class="hljs-number">1</span>)) <span class="hljs-comment"># 当前 Worker 是全局第几个 Worker rank = 0 的主机为 master 节点</span><br>WORLD_SIZE = <span class="hljs-built_in">int</span>(os.getenv(<span class="hljs-string">&quot;WORLD_SIZE&quot;</span>, <span class="hljs-number">1</span>)) <span class="hljs-comment"># 总共有几个Worker </span><br>GIT_INFO = check_git_info()<br></code></pre></td></tr></table></figure>

<h1 id="Train函数"><a href="#Train函数" class="headerlink" title="Train函数"></a>Train函数</h1><p>最重要的部分，<code>train</code>函数包含四个入参：</p>
<ul>
<li><code>hyp</code>：超参数</li>
<li><code>opt</code>： 命令行参数</li>
<li><code>device</code>：当前设备</li>
<li><code>callbacks</code> ：用于存储<code>Loggers</code>日志记录器中的函数，方便在每个训练阶段控制日志的记录情况</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">train</span>(<span class="hljs-params">hyp, opt, device, callbacks</span>):  <span class="hljs-comment"># hyp is path/to/hyp.yaml or hyp dictionary</span><br>	<span class="hljs-comment"># 先从opt获取参数，包含了日志保存路径，轮次、批次、权重、进程序号(主要用于分布式训练)等</span><br>    save_dir, epochs, batch_size, weights, single_cls, evolve, data, cfg, resume, noval, nosave, workers, freeze = (<br>        Path(opt.save_dir),<br>        opt.epochs,<br>        opt.batch_size,<br>        opt.weights,<br>        opt.single_cls,<br>        opt.evolve,<br>        opt.data,<br>        opt.cfg,<br>        opt.resume,<br>        opt.noval,<br>        opt.nosave,<br>        opt.workers,<br>        opt.freeze,<br>    )<br>    callbacks.run(<span class="hljs-string">&quot;on_pretrain_routine_start&quot;</span>)<br><br>    <span class="hljs-comment"># 设置保存权重路径 如runs/train/exp1/weights</span><br>    w = save_dir / <span class="hljs-string">&quot;weights&quot;</span>  <span class="hljs-comment"># weights dir</span><br>    <span class="hljs-comment"># 新建文件夹 weights train evolve</span><br>    (w.parent <span class="hljs-keyword">if</span> evolve <span class="hljs-keyword">else</span> w).mkdir(parents=<span class="hljs-literal">True</span>, exist_ok=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># make dir</span><br>    <span class="hljs-comment"># 保存训练结果的目录，如last.pt和best.pt</span><br>    last, best = w / <span class="hljs-string">&quot;last.pt&quot;</span>, w / <span class="hljs-string">&quot;best.pt&quot;</span><br><br>    <span class="hljs-comment"># 加载超参数</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(hyp, <span class="hljs-built_in">str</span>):<br>        <span class="hljs-comment"># 若hyp是字符串，即认定为路径，则加载超参数为字典</span><br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(hyp, errors=<span class="hljs-string">&quot;ignore&quot;</span>) <span class="hljs-keyword">as</span> f:<br>            hyp = yaml.safe_load(f)  <span class="hljs-comment"># load hyps dict</span><br>    LOGGER.info(colorstr(<span class="hljs-string">&quot;hyperparameters: &quot;</span>) + <span class="hljs-string">&quot;, &quot;</span>.join(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;k&#125;</span>=<span class="hljs-subst">&#123;v&#125;</span>&quot;</span> <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> hyp.items()))<br>    opt.hyp = hyp.copy()  <span class="hljs-comment"># for saving hyps to checkpoints</span><br><br>    <span class="hljs-comment"># Save run settings</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> evolve:<br>        yaml_save(save_dir / <span class="hljs-string">&quot;hyp.yaml&quot;</span>, hyp)<br>        yaml_save(save_dir / <span class="hljs-string">&quot;opt.yaml&quot;</span>, <span class="hljs-built_in">vars</span>(opt))<br><br>    <span class="hljs-comment"># Loggers</span><br>    data_dict = <span class="hljs-literal">None</span><br>    <span class="hljs-keyword">if</span> RANK <span class="hljs-keyword">in</span> &#123;-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>&#125;:<br>        include_loggers = <span class="hljs-built_in">list</span>(LOGGERS)<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">getattr</span>(opt, <span class="hljs-string">&quot;ndjson_console&quot;</span>, <span class="hljs-literal">False</span>):<br>            include_loggers.append(<span class="hljs-string">&quot;ndjson_console&quot;</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">getattr</span>(opt, <span class="hljs-string">&quot;ndjson_file&quot;</span>, <span class="hljs-literal">False</span>):<br>            include_loggers.append(<span class="hljs-string">&quot;ndjson_file&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>这里的<code>Callback</code>方法有点像之前看过的装饰器，首先注册某个事件，当运行到特定事件时进行调用。</p>
<blockquote>
<p>hook函数是程序中预定义好的函数，这个函数处于原有程序流程当中（暴露一个钩子出来）。 我们需要再在有流程中钩子定义的函数块中实现某个具体的细节，需要把我们的实现，挂接或者注册（register）到钩子里，使得hook函数对目标可用。</p>
</blockquote>
<p>hook函数最常使用在某种流程处理当中。这个流程往往有很多步骤。hook函数常常挂载在这些步骤中，为增加额外的一些操作，提供灵活性。</p>
<p>yolov5训练流程中，hook函数在一个训练过程中，会轮询多次训练集，每次称为一个epoch，每个epoch又分为多个batch来训练。 流程先后拆解成:</p>
<ul>
<li>开始训练</li>
<li>训练一个epoch前</li>
<li>训练一个batch前</li>
<li>训练一个batch后</li>
<li>训练一个epoch后。</li>
<li>评估验证集</li>
<li>结束训练</li>
</ul>
<p>这些步骤是穿插在训练一个batch数据的过程中，这些可以理解成是钩子函数，我们可能需要在这些钩子函数中实现一些定制化的东西，比如在训练一个epoch后我们要保存下训练的损失，这时候我们就需要按照以下流程执行：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 要向其注册操作的回调钩子名称</span><br>callbacks.register_action(hook = <span class="hljs-string">&quot;on_pretrain_routine_start&quot;</span>,name = <span class="hljs-string">&quot;log_function&quot;</span> , callback=on_pretrain_routine_start)<br><span class="hljs-comment"># 调用hook，test_kwargs是on_pretrain_routine_start事件对应钩子函数的入参</span><br>callbacks.run(<span class="hljs-string">&quot;on_pretrain_routine_start&quot;</span>,<span class="hljs-string">&quot;test_kwargs&quot;</span>)<br><span class="hljs-comment"># 打印hook信息</span><br>callbacks.get_registered_actions(<span class="hljs-string">&quot;on_pretrain_routine_start&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>以下是源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> threading<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Callbacks</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;&quot; Handles all registered callbacks for YOLOv5 Hooks.&quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># Define the available callbacks</span><br>        self._callbacks = &#123;<br>            <span class="hljs-string">&quot;on_pretrain_routine_start&quot;</span>: [],<br>            <span class="hljs-string">&quot;on_pretrain_routine_end&quot;</span>: [],<br>            <span class="hljs-string">&quot;on_train_start&quot;</span>: [],<br>            <span class="hljs-string">&quot;on_train_epoch_start&quot;</span>: [],<br>            <span class="hljs-string">&quot;on_train_batch_start&quot;</span>: [],<br>            <span class="hljs-string">&quot;optimizer_step&quot;</span>: [],<br>            <span class="hljs-string">&quot;on_before_zero_grad&quot;</span>: [],<br>            <span class="hljs-string">&quot;on_train_batch_end&quot;</span>: [],<br>            <span class="hljs-string">&quot;on_train_epoch_end&quot;</span>: [],<br>            <span class="hljs-string">&quot;on_val_start&quot;</span>: [],<br>            <span class="hljs-string">&quot;on_val_batch_start&quot;</span>: [],<br>            <span class="hljs-string">&quot;on_val_image_end&quot;</span>: [],<br>            <span class="hljs-string">&quot;on_val_batch_end&quot;</span>: [],<br>            <span class="hljs-string">&quot;on_val_end&quot;</span>: [],<br>            <span class="hljs-string">&quot;on_fit_epoch_end&quot;</span>: [],  <span class="hljs-comment"># fit = train + val</span><br>            <span class="hljs-string">&quot;on_model_save&quot;</span>: [],<br>            <span class="hljs-string">&quot;on_train_end&quot;</span>: [],<br>            <span class="hljs-string">&quot;on_params_update&quot;</span>: [],<br>            <span class="hljs-string">&quot;teardown&quot;</span>: [],<br>        &#125;<br>        self.stop_training = <span class="hljs-literal">False</span>  <span class="hljs-comment"># set True to interrupt training</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">register_action</span>(<span class="hljs-params">self, hook, name=<span class="hljs-string">&quot;&quot;</span>, callback=<span class="hljs-literal">None</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Register a new action to a callback hook.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Args:</span><br><span class="hljs-string">            hook: 要向其注册操作的回调钩子名称</span><br><span class="hljs-string">            name: 动作的名称，供以后参考</span><br><span class="hljs-string">            callback: 对fire的回调</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">assert</span> hook <span class="hljs-keyword">in</span> self._callbacks, <span class="hljs-string">f&quot;hook &#x27;<span class="hljs-subst">&#123;hook&#125;</span>&#x27; not found in callbacks <span class="hljs-subst">&#123;self._callbacks&#125;</span>&quot;</span><br>        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">callable</span>(callback), <span class="hljs-string">f&quot;callback &#x27;<span class="hljs-subst">&#123;callback&#125;</span>&#x27; is not callable&quot;</span><br>        self._callbacks[hook].append(&#123;<span class="hljs-string">&quot;name&quot;</span>: name, <span class="hljs-string">&quot;callback&quot;</span>: callback&#125;)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_registered_actions</span>(<span class="hljs-params">self, hook=<span class="hljs-literal">None</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        &quot; Returns all the registered actions by callback hook.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Args:</span><br><span class="hljs-string">            hook: 需要检查的钩子函数名</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> self._callbacks[hook] <span class="hljs-keyword">if</span> hook <span class="hljs-keyword">else</span> self._callbacks<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, hook, *args, thread=<span class="hljs-literal">False</span>, **kwargs</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Loop through the registered actions and fire all callbacks on main thread.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Args:</span><br><span class="hljs-string">            hook: 需要检查的钩子函数名</span><br><span class="hljs-string">            args: 从YoloV5接收的参数</span><br><span class="hljs-string">            thread: (boolean) 是否在线程中执行</span><br><span class="hljs-string">            kwargs: 从YoloV5接收的Keyword</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br><br>        <span class="hljs-keyword">assert</span> hook <span class="hljs-keyword">in</span> self._callbacks, <span class="hljs-string">f&quot;hook &#x27;<span class="hljs-subst">&#123;hook&#125;</span>&#x27; not found in callbacks <span class="hljs-subst">&#123;self._callbacks&#125;</span>&quot;</span><br>        <span class="hljs-keyword">for</span> logger <span class="hljs-keyword">in</span> self._callbacks[hook]:<br>            <span class="hljs-keyword">if</span> thread:<br>                threading.Thread(target=logger[<span class="hljs-string">&quot;callback&quot;</span>], args=args, kwargs=kwargs, daemon=<span class="hljs-literal">True</span>).start()<br>            <span class="hljs-keyword">else</span>:<br>                logger[<span class="hljs-string">&quot;callback&quot;</span>](*args, **kwargs)<br></code></pre></td></tr></table></figure>

<p>随后是加载日志信息：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python">loggers = Loggers(<br>    save_dir=save_dir,<br>    weights=weights,<br>    opt=opt,<br>    hyp=hyp,<br>    logger=LOGGER,<br>    include=<span class="hljs-built_in">tuple</span>(include_loggers),<br>)<br><br><span class="hljs-comment"># Register actions</span><br><span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> methods(loggers):<br>	<span class="hljs-comment"># 将日志记录器中的方法与字符串进行绑定</span><br>    callbacks.register_action(k, callback=<span class="hljs-built_in">getattr</span>(loggers, k))<br><br><span class="hljs-comment"># Process custom dataset artifact link</span><br>data_dict = loggers.remote_dataset<br><span class="hljs-keyword">if</span> resume:  <span class="hljs-comment"># If resuming runs from remote artifact</span><br>    weights, epochs, hyp, batch_size = opt.weights, opt.epochs, opt.hyp, opt.batch_size<br></code></pre></td></tr></table></figure>

<p>加载其他参数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Config</span><br><span class="hljs-comment"># 是否绘图，使用进化算法则不绘制</span><br>plots = <span class="hljs-keyword">not</span> evolve <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> opt.noplots  <span class="hljs-comment"># create plots</span><br>cuda = device.<span class="hljs-built_in">type</span> != <span class="hljs-string">&quot;cpu&quot;</span><br><span class="hljs-comment"># 随机种子</span><br>init_seeds(opt.seed + <span class="hljs-number">1</span> + RANK, deterministic=<span class="hljs-literal">True</span>)<br><br><span class="hljs-comment"># 同步所有进程</span><br><span class="hljs-keyword">with</span> torch_distributed_zero_first(LOCAL_RANK):<br>	<span class="hljs-comment"># 检查数据集，如果没找到数据集则下载数据集(仅适用于项目中自带的yaml文件数据集)</span><br>    data_dict = data_dict <span class="hljs-keyword">or</span> check_dataset(data)  <span class="hljs-comment"># check if None</span><br><span class="hljs-comment"># 获取训练集、测试集图片路径</span><br>train_path, val_path = data_dict[<span class="hljs-string">&quot;train&quot;</span>], data_dict[<span class="hljs-string">&quot;val&quot;</span>]<br><br><span class="hljs-comment"># nc：数据集有多少种类别</span><br>nc = <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> single_cls <span class="hljs-keyword">else</span> <span class="hljs-built_in">int</span>(data_dict[<span class="hljs-string">&quot;nc&quot;</span>])  <span class="hljs-comment"># number of classes</span><br><span class="hljs-comment"># names: 数据集所有类别的名字，如果设置了single_cls则为一类</span><br>names = &#123;<span class="hljs-number">0</span>: <span class="hljs-string">&quot;item&quot;</span>&#125; <span class="hljs-keyword">if</span> single_cls <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(data_dict[<span class="hljs-string">&quot;names&quot;</span>]) != <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> data_dict[<span class="hljs-string">&quot;names&quot;</span>]  <span class="hljs-comment"># class names</span><br><br><span class="hljs-comment"># 当前数据集是否是coco数据集(80个类别)</span><br>is_coco = <span class="hljs-built_in">isinstance</span>(val_path, <span class="hljs-built_in">str</span>) <span class="hljs-keyword">and</span> val_path.endswith(<span class="hljs-string">&quot;coco/val2017.txt&quot;</span>)  <span class="hljs-comment"># COCO dataset</span><br></code></pre></td></tr></table></figure>

<p>下一段是预训练模型的加载：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 模型加载/断点续传</span><br><span class="hljs-comment"># 检查文件后缀是否是.pt</span><br>check_suffix(weights, <span class="hljs-string">&quot;.pt&quot;</span>)  <span class="hljs-comment"># check weights</span><br><span class="hljs-comment"># 加载预训练权重</span><br>pretrained = weights.endswith(<span class="hljs-string">&quot;.pt&quot;</span>)<br><span class="hljs-keyword">if</span> pretrained:<br>	<span class="hljs-comment"># 用于同步不同进程对数据读取的上下文管理器</span><br>    <span class="hljs-keyword">with</span> torch_distributed_zero_first(LOCAL_RANK):<br>        <span class="hljs-comment"># 如果本地不存在就从google云盘中自动下载模型</span><br>        <span class="hljs-comment"># 建议提前下载下来放进weights目录</span><br>        weights = attempt_download(weights)  <span class="hljs-comment"># download if not found locally</span><br>        <br>    <span class="hljs-comment"># 加载模型及参数，加载到CPU以防止显存泄露</span><br>    ckpt = torch.load(weights, map_location=<span class="hljs-string">&quot;cpu&quot;</span>)  <span class="hljs-comment"># load checkpoint to CPU to avoid CUDA memory leak</span><br>    <br>    <span class="hljs-comment"># 加载模型</span><br>    model = Model(cfg <span class="hljs-keyword">or</span> ckpt[<span class="hljs-string">&quot;model&quot;</span>].yaml, ch=<span class="hljs-number">3</span>, nc=nc, anchors=hyp.get(<span class="hljs-string">&quot;anchors&quot;</span>)).to(device)  <span class="hljs-comment"># create</span><br>    <br>    <span class="hljs-comment"># 若cfg 或 hyp.get(&#x27;anchors&#x27;)不为空且不使用中断训练 exclude=[&#x27;anchor&#x27;] 否则 exclude=[]</span><br>    exclude = [<span class="hljs-string">&quot;anchor&quot;</span>] <span class="hljs-keyword">if</span> (cfg <span class="hljs-keyword">or</span> hyp.get(<span class="hljs-string">&quot;anchors&quot;</span>)) <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> resume <span class="hljs-keyword">else</span> []  <span class="hljs-comment"># exclude keys</span><br>    <br>    <span class="hljs-comment"># 将预训练模型中的所有参数保存下来，赋值给csd</span><br>    csd = ckpt[<span class="hljs-string">&quot;model&quot;</span>].<span class="hljs-built_in">float</span>().state_dict()  <span class="hljs-comment"># checkpoint state_dict as FP32</span><br>    <span class="hljs-comment"># 判断预训练参数和新创建的模型参数有多少是相同的</span><br>    <span class="hljs-comment"># 筛选字典中的键值对，把exclude删除</span><br>    csd = intersect_dicts(csd, model.state_dict(), exclude=exclude)  <span class="hljs-comment"># intersect</span><br>    <br>    <span class="hljs-comment"># 模型创建</span><br>    model.load_state_dict(csd, strict=<span class="hljs-literal">False</span>)  <span class="hljs-comment"># load</span><br>    LOGGER.info(<span class="hljs-string">f&quot;Transferred <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(csd)&#125;</span>/<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(model.state_dict())&#125;</span> items from <span class="hljs-subst">&#123;weights&#125;</span>&quot;</span>)  <span class="hljs-comment"># report</span><br><span class="hljs-keyword">else</span>:<br>	<span class="hljs-comment"># 直接加载模型，ch为输入图片通道</span><br>    model = Model(cfg, ch=<span class="hljs-number">3</span>, nc=nc, anchors=hyp.get(<span class="hljs-string">&quot;anchors&quot;</span>)).to(device)  <span class="hljs-comment"># create</span><br>amp = check_amp(model)  <span class="hljs-comment"># check AMP</span><br></code></pre></td></tr></table></figure>

<p>这里有几个函数需要看一下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@contextmanager</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">torch_distributed_zero_first</span>(<span class="hljs-params">local_rank: <span class="hljs-built_in">int</span></span>):<br>    <span class="hljs-keyword">if</span> local_rank <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> [-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>]:<br>        dist.barrier(device_ids=[local_rank])<br>    <span class="hljs-keyword">yield</span><br>    <span class="hljs-keyword">if</span> local_rank == <span class="hljs-number">0</span>:<br>        dist.barrier(device_ids=[<span class="hljs-number">0</span>])<br></code></pre></td></tr></table></figure>

<p>这里的核心是<code>dist.barrier()</code>。是 PyTorch 分布式训练中用于同步进程的一种机制，它能够在所有进程到达同一个 barrier 时进行同步，等待所有进程都完成操作之后才能继续执行。</p>
<p>具体来说，当一个进程调用 <code>dist.barrier()</code> 时，它会阻塞等待其他进程也到达该点。只有当所有进程都到达该 barrier 点时，它们才会被释放，然后可以继续执行后面的代码。</p>
<p>这个方法用来确保非主进程在等待主进程执行某些操作的时候不会执行其他操作，而主进程在完成操作后会等待其他进程到达同步点。</p>
<p>另一个重要的点是<code>@contextmanager</code>和<code>yield</code>。它用来简化上下文管理。</p>
<p>加载模型这边用了<code>Model</code>方法，这个方法来自于<code>DetectionModel</code>类。源码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DetectionModel</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):<br>    <span class="hljs-comment"># YOLOv5 检测模型</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, cfg=<span class="hljs-string">&quot;yolov5s.yaml&quot;</span>, ch=<span class="hljs-number">3</span>, nc=<span class="hljs-literal">None</span>, anchors=<span class="hljs-literal">None</span></span>):  <span class="hljs-comment"># model, input channels, number of classes</span><br>        <span class="hljs-built_in">super</span>().__init__()<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(cfg, <span class="hljs-built_in">dict</span>):<br>            self.yaml = cfg  <span class="hljs-comment"># 模型字典</span><br>        <span class="hljs-keyword">else</span>:  <span class="hljs-comment"># yaml文件</span><br>            <span class="hljs-keyword">import</span> yaml  <span class="hljs-comment"># for torch hub</span><br><br>            self.yaml_file = Path(cfg).name<br>            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(cfg, encoding=<span class="hljs-string">&quot;ascii&quot;</span>, errors=<span class="hljs-string">&quot;ignore&quot;</span>) <span class="hljs-keyword">as</span> f:<br>                self.yaml = yaml.safe_load(f)  <span class="hljs-comment"># model dict</span><br><br>        <span class="hljs-comment"># 定义模型</span><br>        ch = self.yaml[<span class="hljs-string">&quot;ch&quot;</span>] = self.yaml.get(<span class="hljs-string">&quot;ch&quot;</span>, ch)  <span class="hljs-comment"># 从模型的yaml文件中拿到input channels</span><br>        <span class="hljs-keyword">if</span> nc <span class="hljs-keyword">and</span> nc != self.yaml[<span class="hljs-string">&quot;nc&quot;</span>]:<br>            LOGGER.info(<span class="hljs-string">f&quot;Overriding model.yaml nc=<span class="hljs-subst">&#123;self.yaml[<span class="hljs-string">&#x27;nc&#x27;</span>]&#125;</span> with nc=<span class="hljs-subst">&#123;nc&#125;</span>&quot;</span>)<br>            self.yaml[<span class="hljs-string">&quot;nc&quot;</span>] = nc  <span class="hljs-comment"># 覆写yaml value</span><br>        <span class="hljs-keyword">if</span> anchors:<br>            LOGGER.info(<span class="hljs-string">f&quot;Overriding model.yaml anchors with anchors=<span class="hljs-subst">&#123;anchors&#125;</span>&quot;</span>)<br>            self.yaml[<span class="hljs-string">&quot;anchors&quot;</span>] = <span class="hljs-built_in">round</span>(anchors)  <span class="hljs-comment"># 使用hyp的anchors覆写yaml的anchors</span><br>        self.model, self.save = parse_model(deepcopy(self.yaml), ch=[ch])  <span class="hljs-comment"># model, savelist</span><br>        self.names = [<span class="hljs-built_in">str</span>(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.yaml[<span class="hljs-string">&quot;nc&quot;</span>])]  <span class="hljs-comment"># default names</span><br>        self.inplace = self.yaml.get(<span class="hljs-string">&quot;inplace&quot;</span>, <span class="hljs-literal">True</span>)<br><br>        <span class="hljs-comment"># Build strides, anchors</span><br>        m = self.model[-<span class="hljs-number">1</span>]  <span class="hljs-comment"># Detect()</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(m, (Detect, Segment)):<br>            s = <span class="hljs-number">256</span>  <span class="hljs-comment"># 2x min stride</span><br>            m.inplace = self.inplace<br>            forward = <span class="hljs-keyword">lambda</span> x: self.forward(x)[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(m, Segment) <span class="hljs-keyword">else</span> self.forward(x)<br>            m.stride = torch.tensor([s / x.shape[-<span class="hljs-number">2</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> forward(torch.zeros(<span class="hljs-number">1</span>, ch, s, s))])  <span class="hljs-comment"># forward</span><br>            check_anchor_order(m)<br>            m.anchors /= m.stride.view(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)<br>            self.stride = m.stride<br>            self._initialize_biases()  <span class="hljs-comment"># only run once</span><br><br>        <span class="hljs-comment"># Init weights, biases</span><br>        initialize_weights(self)<br>        self.info()<br>        LOGGER.info(<span class="hljs-string">&quot;&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x, augment=<span class="hljs-literal">False</span>, profile=<span class="hljs-literal">False</span>, visualize=<span class="hljs-literal">False</span></span>):<br>        <span class="hljs-keyword">if</span> augment:<br>            <span class="hljs-keyword">return</span> self._forward_augment(x)  <span class="hljs-comment"># augmented inference, None</span><br>        <span class="hljs-keyword">return</span> self._forward_once(x, profile, visualize)  <span class="hljs-comment"># single-scale inference, train</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_forward_augment</span>(<span class="hljs-params">self, x</span>):<br>        img_size = x.shape[-<span class="hljs-number">2</span>:]  <span class="hljs-comment"># height, width</span><br>        s = [<span class="hljs-number">1</span>, <span class="hljs-number">0.83</span>, <span class="hljs-number">0.67</span>]  <span class="hljs-comment"># scales</span><br>        f = [<span class="hljs-literal">None</span>, <span class="hljs-number">3</span>, <span class="hljs-literal">None</span>]  <span class="hljs-comment"># flips (2-ud, 3-lr)</span><br>        y = []  <span class="hljs-comment"># outputs</span><br>        <span class="hljs-keyword">for</span> si, fi <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(s, f):<br>            xi = scale_img(x.flip(fi) <span class="hljs-keyword">if</span> fi <span class="hljs-keyword">else</span> x, si, gs=<span class="hljs-built_in">int</span>(self.stride.<span class="hljs-built_in">max</span>()))<br>            yi = self._forward_once(xi)[<span class="hljs-number">0</span>]  <span class="hljs-comment"># forward</span><br>            yi = self._descale_pred(yi, fi, si, img_size)<br>            y.append(yi)<br>        y = self._clip_augmented(y)  <span class="hljs-comment"># clip augmented tails</span><br>        <span class="hljs-keyword">return</span> torch.cat(y, <span class="hljs-number">1</span>), <span class="hljs-literal">None</span>  <span class="hljs-comment"># augmented inference, train</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_descale_pred</span>(<span class="hljs-params">self, p, flips, scale, img_size</span>):<br>        <span class="hljs-comment"># de-scale predictions following augmented inference (inverse operation)</span><br>        <span class="hljs-keyword">if</span> self.inplace:<br>            p[..., :<span class="hljs-number">4</span>] /= scale  <span class="hljs-comment"># de-scale</span><br>            <span class="hljs-keyword">if</span> flips == <span class="hljs-number">2</span>:<br>                p[..., <span class="hljs-number">1</span>] = img_size[<span class="hljs-number">0</span>] - p[..., <span class="hljs-number">1</span>]  <span class="hljs-comment"># de-flip ud</span><br>            <span class="hljs-keyword">elif</span> flips == <span class="hljs-number">3</span>:<br>                p[..., <span class="hljs-number">0</span>] = img_size[<span class="hljs-number">1</span>] - p[..., <span class="hljs-number">0</span>]  <span class="hljs-comment"># de-flip lr</span><br>        <span class="hljs-keyword">else</span>:<br>            x, y, wh = p[..., <span class="hljs-number">0</span>:<span class="hljs-number">1</span>] / scale, p[..., <span class="hljs-number">1</span>:<span class="hljs-number">2</span>] / scale, p[..., <span class="hljs-number">2</span>:<span class="hljs-number">4</span>] / scale  <span class="hljs-comment"># de-scale</span><br>            <span class="hljs-keyword">if</span> flips == <span class="hljs-number">2</span>:<br>                y = img_size[<span class="hljs-number">0</span>] - y  <span class="hljs-comment"># de-flip ud</span><br>            <span class="hljs-keyword">elif</span> flips == <span class="hljs-number">3</span>:<br>                x = img_size[<span class="hljs-number">1</span>] - x  <span class="hljs-comment"># de-flip lr</span><br>            p = torch.cat((x, y, wh, p[..., <span class="hljs-number">4</span>:]), -<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">return</span> p<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_clip_augmented</span>(<span class="hljs-params">self, y</span>):<br>        <span class="hljs-comment"># Clip YOLOv5 augmented inference tails</span><br>        nl = self.model[-<span class="hljs-number">1</span>].nl  <span class="hljs-comment"># number of detection layers (P3-P5)</span><br>        g = <span class="hljs-built_in">sum</span>(<span class="hljs-number">4</span>**x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(nl))  <span class="hljs-comment"># grid points</span><br>        e = <span class="hljs-number">1</span>  <span class="hljs-comment"># exclude layer count</span><br>        i = (y[<span class="hljs-number">0</span>].shape[<span class="hljs-number">1</span>] // g) * <span class="hljs-built_in">sum</span>(<span class="hljs-number">4</span>**x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(e))  <span class="hljs-comment"># indices</span><br>        y[<span class="hljs-number">0</span>] = y[<span class="hljs-number">0</span>][:, :-i]  <span class="hljs-comment"># large</span><br>        i = (y[-<span class="hljs-number">1</span>].shape[<span class="hljs-number">1</span>] // g) * <span class="hljs-built_in">sum</span>(<span class="hljs-number">4</span> ** (nl - <span class="hljs-number">1</span> - x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(e))  <span class="hljs-comment"># indices</span><br>        y[-<span class="hljs-number">1</span>] = y[-<span class="hljs-number">1</span>][:, i:]  <span class="hljs-comment"># small</span><br>        <span class="hljs-keyword">return</span> y<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_initialize_biases</span>(<span class="hljs-params">self, cf=<span class="hljs-literal">None</span></span>): <br>        m = self.model[-<span class="hljs-number">1</span>]  <span class="hljs-comment"># Detect() module</span><br>        <span class="hljs-keyword">for</span> mi, s <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(m.m, m.stride):  <span class="hljs-comment"># from</span><br>            b = mi.bias.view(m.na, -<span class="hljs-number">1</span>)  <span class="hljs-comment"># conv.bias(255) to (3,85)</span><br>            b.data[:, <span class="hljs-number">4</span>] += math.log(<span class="hljs-number">8</span> / (<span class="hljs-number">640</span> / s) ** <span class="hljs-number">2</span>)  <span class="hljs-comment"># obj (8 objects per 640 image)</span><br>            b.data[:, <span class="hljs-number">5</span> : <span class="hljs-number">5</span> + m.nc] += (<br>                math.log(<span class="hljs-number">0.6</span> / (m.nc - <span class="hljs-number">0.99999</span>)) <span class="hljs-keyword">if</span> cf <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> torch.log(cf / cf.<span class="hljs-built_in">sum</span>())<br>            )  <span class="hljs-comment"># cls</span><br>            mi.bias = torch.nn.Parameter(b.view(-<span class="hljs-number">1</span>), requires_grad=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure>
<p><code>parse_model</code>方法的两个入参分别是<code>d</code>, <code>ch</code>。前者是模型字典，后者是输入通道数。它会遍历读取模型的文件，然后返回一个搭好的nn.Sequential()，也就是搭好的模型。</p>
<p>在加载模型后，可以对模型进一些调整：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python">  <span class="hljs-comment"># 冻结层</span><br>  <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  冻结模型层,设置冻结层名字即可</span><br><span class="hljs-string">  作用：冰冻一些层，就使得这些层在反向传播的时候不再更新权重,需要冻结的层,可以写在freeze列表中</span><br><span class="hljs-string">  freeze为命令行参数，默认为0，表示不冻结</span><br><span class="hljs-string">  &quot;&quot;&quot;</span>    <br><br>  freeze = [<span class="hljs-string">f&quot;model.<span class="hljs-subst">&#123;x&#125;</span>.&quot;</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> (freeze <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(freeze) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-built_in">range</span>(freeze[<span class="hljs-number">0</span>]))]  <span class="hljs-comment"># layers to freeze</span><br>  <br>  <span class="hljs-comment"># 遍历所有层</span><br>  <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> model.named_parameters():<br>  	<span class="hljs-comment"># 为所有层的参数设置梯度</span><br>      v.requires_grad = <span class="hljs-literal">True</span>  <span class="hljs-comment"># train all layers</span><br><span class="hljs-comment"># 冻结训练的层，梯度不更新</span><br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(x <span class="hljs-keyword">in</span> k <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> freeze):<br>          LOGGER.info(<span class="hljs-string">f&quot;freezing <span class="hljs-subst">&#123;k&#125;</span>&quot;</span>)<br>          v.requires_grad = <span class="hljs-literal">False</span><br></code></pre></td></tr></table></figure>

<p>模型设置完就是设置一些训练参数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 图片大小/batch size设置</span><br><span class="hljs-comment"># 获取模型总步长和模型输入图片分辨率</span><br>gs = <span class="hljs-built_in">max</span>(<span class="hljs-built_in">int</span>(model.stride.<span class="hljs-built_in">max</span>()), <span class="hljs-number">32</span>)  <span class="hljs-comment"># grid size (max stride)</span><br><span class="hljs-comment"># 检查输入图片分辨率是否能被32整除</span><br>imgsz = check_img_size(opt.imgsz, gs, floor=gs * <span class="hljs-number">2</span>)  <span class="hljs-comment"># verify imgsz is gs-multiple</span><br><br><span class="hljs-comment"># 设置Batch size</span><br><span class="hljs-keyword">if</span> RANK == -<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> batch_size == -<span class="hljs-number">1</span>:  <span class="hljs-comment"># single-GPU only, estimate best batch size</span><br>    <span class="hljs-comment"># 确保batch size满足要求</span><br>    batch_size = check_train_batch_size(model, imgsz, amp)<br>    loggers.on_params_update(&#123;<span class="hljs-string">&quot;batch_size&quot;</span>: batch_size&#125;)<br><br><span class="hljs-comment"># 优化器设置/分组优化设置</span><br>nbs = <span class="hljs-number">64</span>  <span class="hljs-comment"># nominal batch size</span><br>accumulate = <span class="hljs-built_in">max</span>(<span class="hljs-built_in">round</span>(nbs / batch_size), <span class="hljs-number">1</span>)  <span class="hljs-comment"># accumulate loss before optimizing</span><br><br><span class="hljs-comment"># 根据accumulate设置权重衰减参数，防止过拟合</span><br>hyp[<span class="hljs-string">&quot;weight_decay&quot;</span>] *= batch_size * accumulate / nbs  <span class="hljs-comment"># scale weight_decay</span><br></code></pre></td></tr></table></figure>

<p>这里有几个参数需要注意：</p>
<ul>
<li><p><code>nbs</code>: nominal batch size，名义上的batch_size。这里的nbs跟命令行参数中的batch_size不同，命令行中的batch_size默认为16，nbs设置为64。</p>
</li>
<li><p><code>accumulate</code>: 累计次数，在这里 nbs&#x2F;batch_size（64&#x2F;16）计算出 opt.batch_size输入多少批才达到nbs的水平。简单来说，nbs为64，代表想要达到的batch_size，这里的数值是64；batch_size为opt.batch_size，这里的数值是16。64&#x2F;16等于4，也就是opt.batch_size需要输入4批才能达到nbs，accumulate等于4。(round表示四舍五入取整数，而max表示accumulate不能低于1。)</p>
</li>
<li><p>当给模型喂了4批图片数据后，将四批图片数据得到的梯度值，做累积。当每累积到4批数据时，才会对参数做更新，这样就实现了与batch_size&#x3D;64时相同的效果。</p>
</li>
<li><p>最后还要做权重参数的缩放，因为batch_size发生了变化，所有权重参数也要做相应的缩放。</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 设置优化器</span><br>optimizer = smart_optimizer(model, opt.optimizer, hyp[<span class="hljs-string">&quot;lr0&quot;</span>], hyp[<span class="hljs-string">&quot;momentum&quot;</span>], hyp[<span class="hljs-string">&quot;weight_decay&quot;</span>])<br><br><span class="hljs-comment"># 学习率/EMA/归一化</span><br><span class="hljs-comment"># 是否选择余弦退火学习率</span><br><span class="hljs-keyword">if</span> opt.cos_lr:<br>    lf = one_cycle(<span class="hljs-number">1</span>, hyp[<span class="hljs-string">&quot;lrf&quot;</span>], epochs)  <span class="hljs-comment"># cosine 1-&gt;hyp[&#x27;lrf&#x27;]</span><br><span class="hljs-keyword">else</span>:<br>	<span class="hljs-comment"># 线性学习率，通过线性插值的方式调整学习率</span><br>    lf = <span class="hljs-keyword">lambda</span> x: (<span class="hljs-number">1</span> - x / epochs) * (<span class="hljs-number">1.0</span> - hyp[<span class="hljs-string">&quot;lrf&quot;</span>]) + hyp[<span class="hljs-string">&quot;lrf&quot;</span>]  <span class="hljs-comment"># linear</span><br>scheduler = lr_scheduler.LambdaLR(optimizer, lr_lambda=lf)  <span class="hljs-comment"># plot_lr_scheduler(optimizer, scheduler, epochs)</span><br></code></pre></td></tr></table></figure>

<p>训练前最后准备：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python">   <span class="hljs-comment"># EMA （指数移动平均），考虑历史值对参数的影响，目的是为了收敛的曲线更加平滑</span><br>   <span class="hljs-comment"># 为模型创建EMA指数滑动平均,如果GPU进程数大于1,则不创建</span><br>   ema = ModelEMA(model) <span class="hljs-keyword">if</span> RANK <span class="hljs-keyword">in</span> &#123;-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>&#125; <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span><br><br>   <span class="hljs-comment"># Resume 断点续训</span><br>   <span class="hljs-comment"># 断点续训其实就是把上次训练结束的模型作为预训练模型，并从中加载参数</span><br>   best_fitness, start_epoch = <span class="hljs-number">0.0</span>, <span class="hljs-number">0</span><br>   <br>   <span class="hljs-comment"># 如果有预训练</span><br>   <span class="hljs-keyword">if</span> pretrained:<br>       <span class="hljs-keyword">if</span> resume:<br>       	<span class="hljs-comment"># Epochs 加载训练的迭代次数</span><br>       	<span class="hljs-comment"># start_epoch是从上次的epoch接着训练</span><br>           best_fitness, start_epoch, epochs = smart_resume(ckpt, optimizer, ema, weights, epochs, resume)<br>       <span class="hljs-comment"># 将预训练的相关参数从内存中删除</span><br>       <span class="hljs-keyword">del</span> ckpt, csd<br><br>   <span class="hljs-comment"># DP mode 使用单机多卡模式训练，目前一般不使用</span><br>   <span class="hljs-comment"># rank为进程编号。如果rank=-1且gpu数量&gt;1则使用DataParallel单机多卡模式，效果并不好（分布不平均）</span><br>   <span class="hljs-comment"># rank=-1且gpu数量=1时,不会进行分布式</span><br>   <span class="hljs-keyword">if</span> cuda <span class="hljs-keyword">and</span> RANK == -<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> torch.cuda.device_count() &gt; <span class="hljs-number">1</span>:<br>       LOGGER.warning(<br>           <span class="hljs-string">&quot;WARNING ⚠️ DP not recommended, use torch.distributed.run for best DDP Multi-GPU results.\n&quot;</span><br>           <span class="hljs-string">&quot;See Multi-GPU Tutorial at https://docs.ultralytics.com/yolov5/tutorials/multi_gpu_training to get started.&quot;</span><br>       )<br>       model = torch.nn.DataParallel(model)<br><br><span class="hljs-comment"># SyncBatchNorm  多卡的BN归一化</span><br>   <span class="hljs-keyword">if</span> opt.sync_bn <span class="hljs-keyword">and</span> cuda <span class="hljs-keyword">and</span> RANK != -<span class="hljs-number">1</span>:<br>       model = torch.nn.SyncBatchNorm.convert_sync_batchnorm(model).to(device)<br>       LOGGER.info(<span class="hljs-string">&quot;Using SyncBatchNorm()&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>总结一下，加载模型这边主要做了四件事：</p>
<p>（1）载入模型：载入模型(预训练&#x2F;不预训练) + 检查数据集 + 设置数据集路径参数(train_path、test_path) + 设置冻结层</p>
<p>（2）优化器：参数设置(<code>nbs</code>、<code>accumulate</code>、<code>hyp[&#39;weight_decay&#39;]</code>) + 分组优化(pg0、pg1、pg2) + 选择优化器 + 为三个优化器选择优化方式 + 删除变量</p>
<p>（3）学习率：线性学习率 + one cycle学习率 + 实例化 scheduler + 画出学习率变化曲线</p>
<p>（4）训练前最后准备：EMA + 断点续训+ 迭代次数的加载 + DP + SyncBatchNorm）</p>
<p>加载数据集:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Trainloader 数据加载/Anchor调整</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">返回一个训练数据加载器，一个数据集对象:</span><br><span class="hljs-string">训练数据加载器是一个可迭代的对象，可以通过for循环加载1个batch_size的数据</span><br><span class="hljs-string">数据集对象包括数据集的一些参数，包括所有标签值、所有的训练数据路径、每张图片的尺寸等等</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>train_loader, dataset = create_dataloader(<br>    train_path,<br>    imgsz,<br>    batch_size // WORLD_SIZE,<br>    gs,<br>    single_cls,<br>    hyp=hyp,<br>    augment=<span class="hljs-literal">True</span>,<br>    cache=<span class="hljs-literal">None</span> <span class="hljs-keyword">if</span> opt.cache == <span class="hljs-string">&quot;val&quot;</span> <span class="hljs-keyword">else</span> opt.cache,<br>    rect=opt.rect,<br>    rank=LOCAL_RANK,<br>    workers=workers,<br>    image_weights=opt.image_weights,<br>    quad=opt.quad,<br>    prefix=colorstr(<span class="hljs-string">&quot;train: &quot;</span>),<br>    shuffle=<span class="hljs-literal">True</span>,<br>    seed=opt.seed,<br>)<br>labels = np.concatenate(dataset.labels, <span class="hljs-number">0</span>)<br><br><span class="hljs-comment"># 标签编号最大值</span><br>mlc = <span class="hljs-built_in">int</span>(labels[:, <span class="hljs-number">0</span>].<span class="hljs-built_in">max</span>())  <span class="hljs-comment"># max label class</span><br><br><span class="hljs-comment"># 如果小于类别数则表示有问题</span><br><span class="hljs-keyword">assert</span> mlc &lt; nc, <span class="hljs-string">f&quot;Label class <span class="hljs-subst">&#123;mlc&#125;</span> exceeds nc=<span class="hljs-subst">&#123;nc&#125;</span> in <span class="hljs-subst">&#123;data&#125;</span>. Possible class labels are 0-<span class="hljs-subst">&#123;nc - <span class="hljs-number">1</span>&#125;</span>&quot;</span><br><br><span class="hljs-comment"># Process 0 验证集数据集加载</span><br><span class="hljs-keyword">if</span> RANK <span class="hljs-keyword">in</span> &#123;-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>&#125;:<br>    val_loader = create_dataloader(<br>        val_path,<br>        imgsz,<br>        batch_size // WORLD_SIZE * <span class="hljs-number">2</span>,<br>        gs,<br>        single_cls,<br>        hyp=hyp,<br>        cache=<span class="hljs-literal">None</span> <span class="hljs-keyword">if</span> noval <span class="hljs-keyword">else</span> opt.cache,<br>        rect=<span class="hljs-literal">True</span>,<br>        rank=-<span class="hljs-number">1</span>,<br>        workers=workers * <span class="hljs-number">2</span>,<br>        pad=<span class="hljs-number">0.5</span>,<br>        prefix=colorstr(<span class="hljs-string">&quot;val: &quot;</span>),<br>    )[<span class="hljs-number">0</span>]<br></code></pre></td></tr></table></figure>

<p>Anchor锚框计算：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 如果没有断点续传</span><br>      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> resume:<br>      	<span class="hljs-comment"># Anchors 计算默认锚框anchor与数据集标签框的高宽比</span><br>          <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> opt.noautoanchor:<br>          	<span class="hljs-comment"># 进行自动锚框设置</span><br>              check_anchors(dataset, model=model, thr=hyp[<span class="hljs-string">&quot;anchor_t&quot;</span>], imgsz=imgsz)  <span class="hljs-comment"># run AutoAnchor</span><br>              <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">              参数dataset代表的是训练集，hyp[&#x27;anchor_t&#x27;]是从配置文件hpy.scratch.yaml读取的超参数，anchor_t:4.0</span><br><span class="hljs-string">              当配置文件中的anchor计算bpr（best possible recall）小于0.98时才会重新计算anchor。</span><br><span class="hljs-string">              best possible recall最大值1，如果bpr小于0.98，程序会根据数据集的label自动学习anchor的尺寸</span><br><span class="hljs-string">              &#x27;&#x27;&#x27;</span><br>          <span class="hljs-comment"># 模型半精度</span><br>          model.half().<span class="hljs-built_in">float</span>()  <span class="hljs-comment"># pre-reduce anchor precision</span><br><span class="hljs-comment"># 在每个训练前例行程序结束时触发所有已注册的回调</span><br>      callbacks.run(<span class="hljs-string">&quot;on_pretrain_routine_end&quot;</span>, labels, names)<br><br>  <span class="hljs-comment"># 训练配置/多尺度训练/热身训练</span><br>  <span class="hljs-keyword">if</span> cuda <span class="hljs-keyword">and</span> RANK != -<span class="hljs-number">1</span>:<br>      model = smart_DDP(model)<br></code></pre></td></tr></table></figure>

<p>现在进入训练过程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 模型初始化</span><br>   <span class="hljs-comment"># Model attributes 根据自己数据集的类别数和网络FPN层数设置各个损失的系数</span><br>   nl = de_parallel(model).model[-<span class="hljs-number">1</span>].nl  <span class="hljs-comment"># number of detection layers (to scale hyps)</span><br>   <span class="hljs-comment"># box为预测框的损失</span><br>   hyp[<span class="hljs-string">&quot;box&quot;</span>] *= <span class="hljs-number">3</span> / nl  <span class="hljs-comment"># scale to layers</span><br>   <span class="hljs-comment"># cls为分类的损失</span><br>   hyp[<span class="hljs-string">&quot;cls&quot;</span>] *= nc / <span class="hljs-number">80</span> * <span class="hljs-number">3</span> / nl  <span class="hljs-comment"># scale to classes and layers</span><br>   <span class="hljs-comment"># obj为置信度损失</span><br>   hyp[<span class="hljs-string">&quot;obj&quot;</span>] *= (imgsz / <span class="hljs-number">640</span>) ** <span class="hljs-number">2</span> * <span class="hljs-number">3</span> / nl  <span class="hljs-comment"># scale to image size and layers</span><br>   <span class="hljs-comment"># 标签平滑</span><br>   hyp[<span class="hljs-string">&quot;label_smoothing&quot;</span>] = opt.label_smoothing<br>   <span class="hljs-comment"># 设置模型的类别，然后将检测的类别个数保存到模型</span><br>   model.nc = nc  <br>   <span class="hljs-comment"># 设置模型的超参数，然后将超参数保存到模型</span><br>   model.hyp = hyp  <br>   <span class="hljs-comment"># 从训练的样本标签得到类别权重，然后将类别权重保存至模型</span><br>   model.class_weights = labels_to_class_weights(dataset.labels, nc).to(device) * nc  <span class="hljs-comment"># attach class weights</span><br>   <span class="hljs-comment"># 获取类别的名字，然后将分类标签保存至模型</span><br>   model.names = names<br></code></pre></td></tr></table></figure>

<p>训练热身部分：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Start training</span><br>t0 = time.time()<br><span class="hljs-comment"># Batch数量</span><br>nb = <span class="hljs-built_in">len</span>(train_loader)  <span class="hljs-comment"># number of batches</span><br><span class="hljs-comment"># 获取热身训练的迭代次数</span><br>nw = <span class="hljs-built_in">max</span>(<span class="hljs-built_in">round</span>(hyp[<span class="hljs-string">&quot;warmup_epochs&quot;</span>] * nb), <span class="hljs-number">100</span>)  <span class="hljs-comment"># number of warmup iterations, max(3 epochs, 100 iterations)</span><br><span class="hljs-comment"># nw = min(nw, (epochs - start_epoch) / 2 * nb)  # limit warmup to &lt; 1/2 of training</span><br>last_opt_step = -<span class="hljs-number">1</span><br><br><span class="hljs-comment"># 初始化 map和result，每个class都为0</span><br>maps = np.zeros(nc)  <span class="hljs-comment"># mAP per class</span><br>results = (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)  <span class="hljs-comment"># P, R, mAP@.5, mAP@.5-.95, val_loss(box, obj, cls)</span><br><span class="hljs-comment"># 设置学习率衰减所进行到的轮次，即使打断训练，使用resume接着训练也能正常衔接之前的训练进行学习率衰减</span><br>scheduler.last_epoch = start_epoch - <span class="hljs-number">1</span>  <span class="hljs-comment"># do not move</span><br><span class="hljs-comment"># 设置amp混合精度训练</span><br>scaler = torch.cuda.amp.GradScaler(enabled=amp)<br><span class="hljs-comment"># 早停，不更新结束训练</span><br>stopper, stop = EarlyStopping(patience=opt.patience), <span class="hljs-literal">False</span><br><span class="hljs-comment"># 初始化损失函数</span><br>compute_loss = ComputeLoss(model)  <span class="hljs-comment"># init loss class</span><br>callbacks.run(<span class="hljs-string">&quot;on_train_start&quot;</span>)<br>LOGGER.info(<br>    <span class="hljs-string">f&#x27;Image sizes <span class="hljs-subst">&#123;imgsz&#125;</span> train, <span class="hljs-subst">&#123;imgsz&#125;</span> val\n&#x27;</span><br>    <span class="hljs-string">f&#x27;Using <span class="hljs-subst">&#123;train_loader.num_workers * WORLD_SIZE&#125;</span> dataloader workers\n&#x27;</span><br>    <span class="hljs-string">f&quot;Logging results to <span class="hljs-subst">&#123;colorstr(<span class="hljs-string">&#x27;bold&#x27;</span>, save_dir)&#125;</span>\n&quot;</span><br>    <span class="hljs-string">f&#x27;Starting training for <span class="hljs-subst">&#123;epochs&#125;</span> epochs...&#x27;</span><br>)<br></code></pre></td></tr></table></figure>

<p>开始训练：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(start_epoch, epochs):  <span class="hljs-comment"># epoch ------------------------------------------------------------------</span><br>    callbacks.run(<span class="hljs-string">&quot;on_train_epoch_start&quot;</span>)<br>    model.train()<br><br>    <span class="hljs-comment"># Update image weights (optional, single-GPU only)</span><br>    <span class="hljs-comment"># 获取图片采样的权重</span><br>    <span class="hljs-keyword">if</span> opt.image_weights:<br>    	<span class="hljs-comment"># 经过一轮训练，若哪一类的不精确度高，那么这个类就会被分配一个较高的权重，来增加它被采样的概率</span><br>        cw = model.class_weights.cpu().numpy() * (<span class="hljs-number">1</span> - maps) ** <span class="hljs-number">2</span> / nc  <span class="hljs-comment"># class weights</span><br>        <span class="hljs-comment"># 将计算出的权重换算到图片的维度，将类别的权重换算为图片的权重</span><br>        iw = labels_to_image_weights(dataset.labels, nc=nc, class_weights=cw)  <span class="hljs-comment"># image weights</span><br>        <span class="hljs-comment"># 通过random.choices生成图片索引indices从而进行采样，这时图像会包含一些难识别的样本</span><br>        dataset.indices = random.choices(<span class="hljs-built_in">range</span>(dataset.n), weights=iw, k=dataset.n)  <span class="hljs-comment"># rand weighted idx</span><br></code></pre></td></tr></table></figure>

<p>上面这段代码主要在做两件事：</p>
<ol>
<li>模型训练</li>
<li>更新图片权重：有些类的准确率难以识别，准确率并不会很高。在更新图片权重时就会把这些难以识别的类挑出来，并为这个类产生一些权重高的图片，以这种方式来增加识别率低的类别的数据量。提高准确率。</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python">mloss = torch.zeros(<span class="hljs-number">3</span>, device=device)  <span class="hljs-comment"># mean losses</span><br><span class="hljs-comment"># 分布式训练的设置</span><br><span class="hljs-comment"># DDP模式打乱数据，并且dpp.sampler的随机采样数据是基于epoch+seed作为随机种子，每次epoch不同，随机种子不同</span><br><span class="hljs-keyword">if</span> RANK != -<span class="hljs-number">1</span>:<br>    train_loader.sampler.set_epoch(epoch)<br>    <br><span class="hljs-comment"># 将训练数据迭代器做枚举，可以遍历出索引值</span><br>pbar = <span class="hljs-built_in">enumerate</span>(train_loader)<br>LOGGER.info((<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;%11s&quot;</span> * <span class="hljs-number">7</span>) % (<span class="hljs-string">&quot;Epoch&quot;</span>, <span class="hljs-string">&quot;GPU_mem&quot;</span>, <span class="hljs-string">&quot;box_loss&quot;</span>, <span class="hljs-string">&quot;obj_loss&quot;</span>, <span class="hljs-string">&quot;cls_loss&quot;</span>, <span class="hljs-string">&quot;Instances&quot;</span>, <span class="hljs-string">&quot;Size&quot;</span>))<br><span class="hljs-keyword">if</span> RANK <span class="hljs-keyword">in</span> &#123;-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>&#125;:<br>	<span class="hljs-comment"># 通过tqdm创建进度条，方便训练信息的展示</span><br>    pbar = tqdm(pbar, total=nb, bar_format=TQDM_BAR_FORMAT)  <span class="hljs-comment"># progress bar</span><br><span class="hljs-comment"># 优化器中所有参数清零</span><br>optimizer.zero_grad()<br></code></pre></td></tr></table></figure>

<p>接下来是对单个Batch的训练：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> i, (imgs, targets, paths, _) <span class="hljs-keyword">in</span> pbar:  <span class="hljs-comment"># batch -------------------------------------------------------------</span><br>    callbacks.run(<span class="hljs-string">&quot;on_train_batch_start&quot;</span>)<br>    <span class="hljs-comment"># ni: 计算当前迭代次数 iteration</span><br>    ni = i + nb * epoch  <span class="hljs-comment"># number integrated batches (since train start)</span><br>    <span class="hljs-comment"># 将图片加载至设备 并做归一化</span><br>    imgs = imgs.to(device, non_blocking=<span class="hljs-literal">True</span>).<span class="hljs-built_in">float</span>() / <span class="hljs-number">255</span>  <span class="hljs-comment"># uint8 to float32, 0-255 to 0.0-1.0</span><br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    热身训练(前nw次迭代),热身训练迭代的次数iteration范围[1:nw] </span><br><span class="hljs-string">    在前nw次迭代中, 根据以下方式选取accumulate和学习率</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    <span class="hljs-comment"># Warmup</span><br>    <span class="hljs-keyword">if</span> ni &lt;= nw:<br>        xi = [<span class="hljs-number">0</span>, nw]  <span class="hljs-comment"># x interp</span><br>        <span class="hljs-comment"># compute_loss.gr = np.interp(ni, xi, [0.0, 1.0])  # iou loss ratio (obj_loss = 1.0 or iou)</span><br>        accumulate = <span class="hljs-built_in">max</span>(<span class="hljs-number">1</span>, np.interp(ni, xi, [<span class="hljs-number">1</span>, nbs / batch_size]).<span class="hljs-built_in">round</span>())<br>        <br>        <span class="hljs-comment"># 遍历优化器中的所有参数组</span><br>        <span class="hljs-keyword">for</span> j, x <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(optimizer.param_groups):<br>            <span class="hljs-comment"># bias lr falls from 0.1 to lr0, all other lrs rise from 0.0 to lr0</span><br>            <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">            bias的学习率从0.1下降到基准学习率lr*lf(epoch)，</span><br><span class="hljs-string">            其他的参数学习率从0增加到lr*lf(epoch).</span><br><span class="hljs-string">            lf为上面设置的余弦退火的衰减函数</span><br><span class="hljs-string">            &quot;&quot;&quot;</span><br>            x[<span class="hljs-string">&quot;lr&quot;</span>] = np.interp(ni, xi, [hyp[<span class="hljs-string">&quot;warmup_bias_lr&quot;</span>] <span class="hljs-keyword">if</span> j == <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0.0</span>, x[<span class="hljs-string">&quot;initial_lr&quot;</span>] * lf(epoch)])<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;momentum&quot;</span> <span class="hljs-keyword">in</span> x:<br>                x[<span class="hljs-string">&quot;momentum&quot;</span>] = np.interp(ni, xi, [hyp[<span class="hljs-string">&quot;warmup_momentum&quot;</span>], hyp[<span class="hljs-string">&quot;momentum&quot;</span>]])<br><br>    <span class="hljs-comment"># Multi-scale 设置多尺度训练，从imgsz * 0.5, imgsz * 1.5 + gs随机选取尺寸</span><br>    <span class="hljs-comment"># imgsz: 默认训练尺寸   gs: 模型最大stride=32   [32 16 8]       </span><br>    <span class="hljs-keyword">if</span> opt.multi_scale:<br>        sz = random.randrange(<span class="hljs-built_in">int</span>(imgsz * <span class="hljs-number">0.5</span>), <span class="hljs-built_in">int</span>(imgsz * <span class="hljs-number">1.5</span>) + gs) // gs * gs  <span class="hljs-comment"># size</span><br>        sf = sz / <span class="hljs-built_in">max</span>(imgs.shape[<span class="hljs-number">2</span>:])  <span class="hljs-comment"># scale factor</span><br>        <span class="hljs-keyword">if</span> sf != <span class="hljs-number">1</span>:<br>            ns = [math.ceil(x * sf / gs) * gs <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> imgs.shape[<span class="hljs-number">2</span>:]]  <span class="hljs-comment"># new shape (stretched to gs-multiple)</span><br>            <span class="hljs-comment"># 下采样</span><br>            imgs = nn.functional.interpolate(imgs, size=ns, mode=<span class="hljs-string">&quot;bilinear&quot;</span>, align_corners=<span class="hljs-literal">False</span>)<br></code></pre></td></tr></table></figure>

<p>前向传播：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs python">    <span class="hljs-comment"># Forward</span><br>    <span class="hljs-keyword">with</span> torch.cuda.amp.autocast(amp):<br>    	<span class="hljs-comment"># 推理</span><br>        pred = model(imgs)  <span class="hljs-comment"># forward</span><br>        <span class="hljs-comment"># 计算三个损失：分类损失，置信度损失，框损失</span><br>        loss, loss_items = compute_loss(pred, targets.to(device))  <span class="hljs-comment"># loss scaled by batch_size</span><br>        <span class="hljs-keyword">if</span> RANK != -<span class="hljs-number">1</span>:<br>        <br>        	<span class="hljs-comment"># 采用DDP训练,平均不同gpu之间的梯度</span><br>            loss *= WORLD_SIZE  <span class="hljs-comment"># gradient averaged between devices in DDP mode</span><br>        <span class="hljs-keyword">if</span> opt.quad:<br>            loss *= <span class="hljs-number">4.0</span><br><br>    <span class="hljs-comment"># Backward 反向传播 scale为使用自动混合精度运算</span><br>    scaler.scale(loss).backward()<br><br>    <span class="hljs-comment"># Optimize </span><br>    <span class="hljs-comment"># 模型会对多批数据进行累积，只有达到累计次数的时候才会更新参数，再还没有达到累积次数时 loss会不断的叠加 不会被新的反向传播替代</span><br>    <span class="hljs-keyword">if</span> ni - last_opt_step &gt;= accumulate:      <br>        scaler.unscale_(optimizer)  <span class="hljs-comment"># unscale gradients</span><br>        torch.nn.utils.clip_grad_norm_(model.parameters(), max_norm=<span class="hljs-number">10.0</span>)  <span class="hljs-comment"># clip gradients</span><br>        <br>        <span class="hljs-comment"># 参数更新</span><br>        scaler.step(optimizer)  <span class="hljs-comment"># optimizer.step</span><br>        scaler.update()<br>        <br>        <span class="hljs-comment"># 梯度清零</span><br>        optimizer.zero_grad()<br>        <span class="hljs-keyword">if</span> ema:<br>            ema.update(model)<br>        <br>        <span class="hljs-comment"># 计数</span><br>        last_opt_step = ni<br><br>    <span class="hljs-comment"># Log</span><br>    <span class="hljs-keyword">if</span> RANK <span class="hljs-keyword">in</span> &#123;-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>&#125;:<br>        mloss = (mloss * i + loss_items) / (i + <span class="hljs-number">1</span>)  <span class="hljs-comment"># update mean losses</span><br>        mem = <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;torch.cuda.memory_reserved() / <span class="hljs-number">1E9</span> <span class="hljs-keyword">if</span> torch.cuda.is_available() <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>:<span class="hljs-number">.3</span>g&#125;</span>G&quot;</span>  <span class="hljs-comment"># (GB)</span><br>        pbar.set_description(<br>            (<span class="hljs-string">&quot;%11s&quot;</span> * <span class="hljs-number">2</span> + <span class="hljs-string">&quot;%11.4g&quot;</span> * <span class="hljs-number">5</span>)<br>            % (<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;epoch&#125;</span>/<span class="hljs-subst">&#123;epochs - <span class="hljs-number">1</span>&#125;</span>&quot;</span>, mem, *mloss, targets.shape[<span class="hljs-number">0</span>], imgs.shape[-<span class="hljs-number">1</span>])<br>        )<br>        callbacks.run(<span class="hljs-string">&quot;on_train_batch_end&quot;</span>, model, ni, imgs, targets, paths, <span class="hljs-built_in">list</span>(mloss))<br>        <span class="hljs-keyword">if</span> callbacks.stop_training:<br>            <span class="hljs-keyword">return</span><br>    <span class="hljs-comment"># end batch ------------------------------------------------------------------------------------------------</span><br><br><span class="hljs-comment"># 进行学习率衰减</span><br>lr = [x[<span class="hljs-string">&quot;lr&quot;</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> optimizer.param_groups]  <span class="hljs-comment"># for loggers</span><br>scheduler.step()<br></code></pre></td></tr></table></figure>

<p>模型保存：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span> RANK <span class="hljs-keyword">in</span> &#123;-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>&#125;:<br>    <span class="hljs-comment"># mAP</span><br>    callbacks.run(<span class="hljs-string">&quot;on_train_epoch_end&quot;</span>, epoch=epoch)<br>    <br>    <span class="hljs-comment"># 将model中的属性赋值给ema</span><br>    ema.update_attr(model, include=[<span class="hljs-string">&quot;yaml&quot;</span>, <span class="hljs-string">&quot;nc&quot;</span>, <span class="hljs-string">&quot;hyp&quot;</span>, <span class="hljs-string">&quot;names&quot;</span>, <span class="hljs-string">&quot;stride&quot;</span>, <span class="hljs-string">&quot;class_weights&quot;</span>])<br>    <br>    <span class="hljs-comment"># 判断当前epoch是否是最后一轮</span><br>    final_epoch = (epoch + <span class="hljs-number">1</span> == epochs) <span class="hljs-keyword">or</span> stopper.possible_stop<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> noval <span class="hljs-keyword">or</span> final_epoch:  <span class="hljs-comment"># Calculate mAP</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        测试使用的是ema（指数移动平均 对模型的参数做平均）的模型</span><br><span class="hljs-string">               results: [1] Precision 所有类别的平均precision(最大f1时)</span><br><span class="hljs-string">                        [1] Recall 所有类别的平均recall</span><br><span class="hljs-string">                        [1] map@0.5 所有类别的平均mAP@0.5</span><br><span class="hljs-string">                        [1] map@0.5:0.95 所有类别的平均mAP@0.5:0.95</span><br><span class="hljs-string">                        [1] box_loss 验证集回归损失, obj_loss 验证集置信度损失, cls_loss 验证集分类损失</span><br><span class="hljs-string">               maps: [80] 所有类别的mAP@0.5:0.95</span><br><span class="hljs-string">        &quot;&quot;&quot;</span>            <br>        results, maps, _ = validate.run(<br>            data_dict, <span class="hljs-comment"># 数据集配置文件地址 包含数据集的路径、类别个数、类名、下载地址等信息</span><br>            batch_size=batch_size // WORLD_SIZE * <span class="hljs-number">2</span>, <span class="hljs-comment"># 要保证batch_size能整除卡数</span><br>            imgsz=imgsz,<br>            half=amp,<br>            model=ema.ema,<br>            single_cls=single_cls,<br>            dataloader=val_loader,<br>            save_dir=save_dir,<br>            plots=<span class="hljs-literal">False</span>,<br>            callbacks=callbacks,<br>            compute_loss=compute_loss,<br>        )<br><br>    <span class="hljs-comment"># 更新best_fitness</span><br>    <span class="hljs-comment"># fi: [P, R, mAP@.5, mAP@.5-.95]的一个加权值 = 0.1*mAP@.5 + 0.9*mAP@.5-.95</span><br>    fi = fitness(np.array(results).reshape(<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>))  <br>    <span class="hljs-comment"># 检查是否早停</span><br>    stop = stopper(epoch=epoch, fitness=fi)  <span class="hljs-comment"># early stop check</span><br>    <br>    <span class="hljs-comment"># 若当前的fitness大于最佳的fitness</span><br>    <span class="hljs-keyword">if</span> fi &gt; best_fitness:<br>    	<span class="hljs-comment"># 将最佳fitness更新为当前fitness</span><br>        best_fitness = fi<br>        <br>    <span class="hljs-comment"># 保存验证结果</span><br>    log_vals = <span class="hljs-built_in">list</span>(mloss) + <span class="hljs-built_in">list</span>(results) + lr<br>    callbacks.run(<span class="hljs-string">&quot;on_fit_epoch_end&quot;</span>, log_vals, epoch, best_fitness, fi)<br></code></pre></td></tr></table></figure>

<p>保存模型：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python">        <span class="hljs-comment"># Save model</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        保存带checkpoint的模型用于inference或resuming training</span><br><span class="hljs-string">        保存模型, 还保存了epoch, results, optimizer等信息</span><br><span class="hljs-string">        optimizer将不会在最后一轮完成后保存</span><br><span class="hljs-string">        model保存的是EMA的模型</span><br><span class="hljs-string">        &quot;&quot;&quot;</span>            <br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">not</span> nosave) <span class="hljs-keyword">or</span> (final_epoch <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> evolve):  <span class="hljs-comment"># if save</span><br>        	<span class="hljs-comment"># 将当前训练过程中的所有参数赋值给ckpt</span><br>            ckpt = &#123;<br>                <span class="hljs-string">&quot;epoch&quot;</span>: epoch,<br>                <span class="hljs-string">&quot;best_fitness&quot;</span>: best_fitness,<br>                <span class="hljs-string">&quot;model&quot;</span>: deepcopy(de_parallel(model)).half(),<br>                <span class="hljs-string">&quot;ema&quot;</span>: deepcopy(ema.ema).half(),<br>                <span class="hljs-string">&quot;updates&quot;</span>: ema.updates,<br>                <span class="hljs-string">&quot;optimizer&quot;</span>: optimizer.state_dict(),<br>                <span class="hljs-string">&quot;opt&quot;</span>: <span class="hljs-built_in">vars</span>(opt),<br>                <span class="hljs-string">&quot;git&quot;</span>: GIT_INFO,  <span class="hljs-comment"># &#123;remote, branch, commit&#125; if a git repo</span><br>                <span class="hljs-string">&quot;date&quot;</span>: datetime.now().isoformat(),<br>            &#125;<br><br>            <span class="hljs-comment"># Save last, best and delete 保存每轮的模型</span><br>            torch.save(ckpt, last)<br>            <br>            <span class="hljs-comment"># 如果这个模型的fitness是最佳的</span><br>            <span class="hljs-keyword">if</span> best_fitness == fi:<br>                torch.save(ckpt, best)<br>            <span class="hljs-keyword">if</span> opt.save_period &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> epoch % opt.save_period == <span class="hljs-number">0</span>:<br>                torch.save(ckpt, w / <span class="hljs-string">f&quot;epoch<span class="hljs-subst">&#123;epoch&#125;</span>.pt&quot;</span>)<br>                <br>            <span class="hljs-comment"># 模型保存完毕 将变量从内存中删除</span><br>            <span class="hljs-keyword">del</span> ckpt<br>            callbacks.run(<span class="hljs-string">&quot;on_model_save&quot;</span>, last, epoch, final_epoch, best_fitness, fi)<br><br>    <span class="hljs-comment"># EarlyStopping</span><br>    <span class="hljs-keyword">if</span> RANK != -<span class="hljs-number">1</span>:  <span class="hljs-comment"># if DDP training</span><br>        broadcast_list = [stop <span class="hljs-keyword">if</span> RANK == <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>]<br>        dist.broadcast_object_list(broadcast_list, <span class="hljs-number">0</span>)  <span class="hljs-comment"># broadcast &#x27;stop&#x27; to all ranks</span><br>        <span class="hljs-keyword">if</span> RANK != <span class="hljs-number">0</span>:<br>            stop = broadcast_list[<span class="hljs-number">0</span>]<br>    <span class="hljs-keyword">if</span> stop:<br>        <span class="hljs-keyword">break</span>  <span class="hljs-comment"># must break all DDP ranks</span><br><br>    <span class="hljs-comment"># end epoch ----------------------------------------------------------------------------------------------------</span><br><span class="hljs-comment"># end training -----------------------------------------------------------------------------------------------------</span><br></code></pre></td></tr></table></figure>

<p>总结一下训练过程，同样分为四块：</p>
<p>（1）初始化训练需要的模型参数：设置&#x2F;初始化一些训练要用的参数(<code>hyp[&#39;box&#39;]</code>、<code>hyp[&#39;cls&#39;]</code>、<code>hyp[&#39;obj&#39;]</code>、<code>hyp[&#39;label_smoothing&#39;]</code>）+ 从训练样本标签得到类别权重<code>model.class_weights</code>、<code>model.names</code>。</p>
<p>（2）热身部分：热身迭代的次数<code>iterationsnw</code>、<code>last_opt_step</code>、初始化maps和results、学习率衰减所进行到的轮次<code>scheduler.last_epoch</code> + 设置amp混合精度训练<code>scaler</code> + 初始化损失函数<code>compute_loss</code> + 打印日志信息)</p>
<p>（3）开始训练：图片采样策略 + <code>Warmup</code>热身训练 + <code>multi_scale</code>多尺度训练 + amp混合精度训练 +  <code>accumulate</code> 梯度更新策略+ 打印训练相关信息(包括当前epoch、显存、损失(box、obj、cls、total) + 当前batch的target的数量和图片的size等  + 调整学习率、<code>scheduler.step()</code>、<code>emp val.run()</code>得到results, maps相关信息</p>
<p>（4）训练完成保存模型：将测试结果results写入日志，更新best mAP，以加权mAP fitness为衡量标准+保存模型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 训练结束/打印信息/保存结果</span><br><span class="hljs-keyword">if</span> RANK <span class="hljs-keyword">in</span> &#123;-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>&#125;:<br>    LOGGER.info(<span class="hljs-string">f&quot;\n<span class="hljs-subst">&#123;epoch - start_epoch + <span class="hljs-number">1</span>&#125;</span> epochs completed in <span class="hljs-subst">&#123;(time.time() - t0) / <span class="hljs-number">3600</span>:<span class="hljs-number">.3</span>f&#125;</span> hours.&quot;</span>)<br>    <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> last, best:<br>        <span class="hljs-keyword">if</span> f.exists():<br>            strip_optimizer(f)  <span class="hljs-comment"># strip optimizers</span><br>            <span class="hljs-keyword">if</span> f <span class="hljs-keyword">is</span> best:<br>                LOGGER.info(<span class="hljs-string">f&quot;\nValidating <span class="hljs-subst">&#123;f&#125;</span>...&quot;</span>)<br>                results, _, _ = validate.run(<br>                    data_dict,<br>                    batch_size=batch_size // WORLD_SIZE * <span class="hljs-number">2</span>,<br>                    imgsz=imgsz,<br>                    model=attempt_load(f, device).half(),<br>                    iou_thres=<span class="hljs-number">0.65</span> <span class="hljs-keyword">if</span> is_coco <span class="hljs-keyword">else</span> <span class="hljs-number">0.60</span>,  <span class="hljs-comment"># best pycocotools at iou 0.65</span><br>                    single_cls=single_cls,<br>                    dataloader=val_loader,<br>                    save_dir=save_dir,<br>                    save_json=is_coco,<br>                    verbose=<span class="hljs-literal">True</span>,<br>                    plots=plots,<br>                    callbacks=callbacks,<br>                    compute_loss=compute_loss,<br>                )  <span class="hljs-comment"># val best model with plots</span><br>                <span class="hljs-keyword">if</span> is_coco:<br>                    callbacks.run(<span class="hljs-string">&quot;on_fit_epoch_end&quot;</span>, <span class="hljs-built_in">list</span>(mloss) + <span class="hljs-built_in">list</span>(results) + lr, epoch, best_fitness, fi)<br><br>    callbacks.run(<span class="hljs-string">&quot;on_train_end&quot;</span>, last, best, epoch, results)<br><br>torch.cuda.empty_cache()<br><span class="hljs-keyword">return</span> results<br></code></pre></td></tr></table></figure>

<h1 id="参数设置"><a href="#参数设置" class="headerlink" title="参数设置"></a>参数设置</h1><p><code>parse_opt</code>函数主要负责解析一些命令行参数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_opt</span>(<span class="hljs-params">known=<span class="hljs-literal">False</span></span>):<br>    parser = argparse.ArgumentParser()<br>    <span class="hljs-comment"># 预训练权重文件</span><br>    parser.add_argument(<span class="hljs-string">&quot;--weights&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, default=ROOT / <span class="hljs-string">&quot;yolov5s.pt&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;initial weights path&quot;</span>)<br>    <span class="hljs-comment"># 训练模型</span><br>    parser.add_argument(<span class="hljs-string">&quot;--cfg&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, default=<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;model.yaml path&quot;</span>)<br>    <span class="hljs-comment"># 训练路径，包括训练集，验证集，测试集的路径，类别总数等</span><br>    parser.add_argument(<span class="hljs-string">&quot;--data&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, default=ROOT / <span class="hljs-string">&quot;data/coco128.yaml&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;dataset.yaml path&quot;</span>)<br>    <span class="hljs-comment"># hpy超参数设置文件</span><br>    parser.add_argument(<span class="hljs-string">&quot;--hyp&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, default=ROOT / <span class="hljs-string">&quot;data/hyps/hyp.scratch-low.yaml&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;hyperparameters path&quot;</span>)<br>    <span class="hljs-comment"># epochs: 训练轮次， 默认轮次为300次</span><br>    parser.add_argument(<span class="hljs-string">&quot;--epochs&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=<span class="hljs-number">100</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;total training epochs&quot;</span>)<br>    <span class="hljs-comment"># batchsize: 训练批次， 默认bs=16</span><br>    parser.add_argument(<span class="hljs-string">&quot;--batch-size&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=<span class="hljs-number">16</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;total batch size for all GPUs, -1 for autobatch&quot;</span>)<br>    <span class="hljs-comment"># imagesize: 设置图片大小, 默认640*640</span><br>    parser.add_argument(<span class="hljs-string">&quot;--imgsz&quot;</span>, <span class="hljs-string">&quot;--img&quot;</span>, <span class="hljs-string">&quot;--img-size&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=<span class="hljs-number">640</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;train, val image size (pixels)&quot;</span>)<br>    <span class="hljs-comment"># rect: 是否采用矩形训练，默认为False</span><br>    <span class="hljs-comment"># 矩形训练：将比例相近的图片放在一个batch</span><br>    parser.add_argument(<span class="hljs-string">&quot;--rect&quot;</span>, action=<span class="hljs-string">&quot;store_true&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;rectangular training&quot;</span>)<br>    <span class="hljs-comment"># resume: 是否接着上次的训练结果，继续训练</span><br>    parser.add_argument(<span class="hljs-string">&quot;--resume&quot;</span>, nargs=<span class="hljs-string">&quot;?&quot;</span>, const=<span class="hljs-literal">True</span>, default=<span class="hljs-literal">False</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;resume most recent training&quot;</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;--nosave&quot;</span>, action=<span class="hljs-string">&quot;store_true&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;only save final checkpoint&quot;</span>)<br>    <span class="hljs-comment"># noval: 最后进行测试, 设置了之后就是训练结束都测试一下</span><br>    parser.add_argument(<span class="hljs-string">&quot;--noval&quot;</span>, action=<span class="hljs-string">&quot;store_true&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;only validate final epoch&quot;</span>)<br>    <span class="hljs-comment"># noautoanchor: 不自动调整anchor, 默认False</span><br>    parser.add_argument(<span class="hljs-string">&quot;--noautoanchor&quot;</span>, action=<span class="hljs-string">&quot;store_true&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;disable AutoAnchor&quot;</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;--noplots&quot;</span>, action=<span class="hljs-string">&quot;store_true&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;save no plot files&quot;</span>)<br>    <span class="hljs-comment"># 进化策略轮次</span><br>    parser.add_argument(<span class="hljs-string">&quot;--evolve&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, nargs=<span class="hljs-string">&quot;?&quot;</span>, const=<span class="hljs-number">300</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;evolve hyperparameters for x generations&quot;</span>)<br>    parser.add_argument(<br>        <span class="hljs-string">&quot;--evolve_population&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, default=ROOT / <span class="hljs-string">&quot;data/hyps&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;location for loading population&quot;</span><br>    )<br>    parser.add_argument(<span class="hljs-string">&quot;--resume_evolve&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, default=<span class="hljs-literal">None</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;resume evolve from last generation&quot;</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;--bucket&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, default=<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;gsutil bucket&quot;</span>)<br>    <span class="hljs-comment"># cache: 是否提前缓存图片到内存，以加快训练速度</span><br>    parser.add_argument(<span class="hljs-string">&quot;--cache&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, nargs=<span class="hljs-string">&quot;?&quot;</span>, const=<span class="hljs-string">&quot;ram&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;image --cache ram/disk&quot;</span>)<br>    <span class="hljs-comment"># image-weights: 使用图片采样策略，默认不使用</span><br>    parser.add_argument(<span class="hljs-string">&quot;--image-weights&quot;</span>, action=<span class="hljs-string">&quot;store_true&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;use weighted image selection for training&quot;</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;--device&quot;</span>, default=<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;cuda device, i.e. 0 or 0,1,2,3 or cpu&quot;</span>)<br>    <span class="hljs-comment"># multi-scale 是否进行多尺度训练</span><br>    parser.add_argument(<span class="hljs-string">&quot;--multi-scale&quot;</span>, action=<span class="hljs-string">&quot;store_true&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;vary img-size +/- 50%%&quot;</span>)<br>    <span class="hljs-comment"># single-cls: 数据集是否多类/默认True</span><br>    parser.add_argument(<span class="hljs-string">&quot;--single-cls&quot;</span>, action=<span class="hljs-string">&quot;store_true&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;train multi-class data as single-class&quot;</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;--optimizer&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, choices=[<span class="hljs-string">&quot;SGD&quot;</span>, <span class="hljs-string">&quot;Adam&quot;</span>, <span class="hljs-string">&quot;AdamW&quot;</span>], default=<span class="hljs-string">&quot;SGD&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;optimizer&quot;</span>)<br>    <span class="hljs-comment"># 同步BatchNorm</span><br>    parser.add_argument(<span class="hljs-string">&quot;--sync-bn&quot;</span>, action=<span class="hljs-string">&quot;store_true&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;use SyncBatchNorm, only available in DDP mode&quot;</span>)<br>    <span class="hljs-comment"># dataloader的最大worker数量 （使用多线程加载图片）</span><br>    parser.add_argument(<span class="hljs-string">&quot;--workers&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=<span class="hljs-number">8</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;max dataloader workers (per RANK in DDP mode)&quot;</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;--project&quot;</span>, default=ROOT / <span class="hljs-string">&quot;runs/train&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;save to project/name&quot;</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;--name&quot;</span>, default=<span class="hljs-string">&quot;exp&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;save to project/name&quot;</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;--exist-ok&quot;</span>, action=<span class="hljs-string">&quot;store_true&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;existing project/name ok, do not increment&quot;</span>)<br>    <span class="hljs-comment"># 四元数据加载器: 允许在较低 --img 尺寸下进行更高 --img 尺寸训练</span><br>    parser.add_argument(<span class="hljs-string">&quot;--quad&quot;</span>, action=<span class="hljs-string">&quot;store_true&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;quad dataloader&quot;</span>)<br>    <span class="hljs-comment"># cos-lr: 余弦学习率</span><br>    parser.add_argument(<span class="hljs-string">&quot;--cos-lr&quot;</span>, action=<span class="hljs-string">&quot;store_true&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;cosine LR scheduler&quot;</span>)<br>    <span class="hljs-comment"># 标签平滑 / 默认不增强</span><br>    parser.add_argument(<span class="hljs-string">&quot;--label-smoothing&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">float</span>, default=<span class="hljs-number">0.0</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;Label smoothing epsilon&quot;</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;--patience&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=<span class="hljs-number">100</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;EarlyStopping patience (epochs without improvement)&quot;</span>)<br>    <span class="hljs-comment"># freeze冻结训练</span><br>    parser.add_argument(<span class="hljs-string">&quot;--freeze&quot;</span>, nargs=<span class="hljs-string">&quot;+&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=[<span class="hljs-number">0</span>], <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;Freeze layers: backbone=10, first3=0 1 2&quot;</span>)<br>    <span class="hljs-comment"># 多少个epoch保存一次</span><br>    parser.add_argument(<span class="hljs-string">&quot;--save-period&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=-<span class="hljs-number">1</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;Save checkpoint every x epochs (disabled if &lt; 1)&quot;</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;--seed&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=<span class="hljs-number">0</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;Global training seed&quot;</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;--local_rank&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=-<span class="hljs-number">1</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;Automatic DDP Multi-GPU argument, do not modify&quot;</span>)<br><br>    <span class="hljs-comment"># Logger arguments</span><br>    parser.add_argument(<span class="hljs-string">&quot;--entity&quot;</span>, default=<span class="hljs-literal">None</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;Entity&quot;</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;--upload_dataset&quot;</span>, nargs=<span class="hljs-string">&quot;?&quot;</span>, const=<span class="hljs-literal">True</span>, default=<span class="hljs-literal">False</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;Upload data, &quot;val&quot; option&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;--bbox_interval&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=-<span class="hljs-number">1</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;Set bounding-box image logging interval&quot;</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;--artifact_alias&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, default=<span class="hljs-string">&quot;latest&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;Version of dataset artifact to use&quot;</span>)<br><br>    <span class="hljs-comment"># NDJSON logging</span><br>    parser.add_argument(<span class="hljs-string">&quot;--ndjson-console&quot;</span>, action=<span class="hljs-string">&quot;store_true&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;Log ndjson to console&quot;</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;--ndjson-file&quot;</span>, action=<span class="hljs-string">&quot;store_true&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;Log ndjson to file&quot;</span>)<br><br>    <span class="hljs-keyword">return</span> parser.parse_known_args()[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> known <span class="hljs-keyword">else</span> parser.parse_args()<br></code></pre></td></tr></table></figure>

<h1 id="Main函数"><a href="#Main函数" class="headerlink" title="Main函数"></a>Main函数</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>(<span class="hljs-params">opt, callbacks=Callbacks(<span class="hljs-params"></span>)</span>):<br>    <span class="hljs-comment"># 检查分布式训练环境</span><br>    <span class="hljs-keyword">if</span> RANK <span class="hljs-keyword">in</span> &#123;-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>&#125;: <br>        print_args(<span class="hljs-built_in">vars</span>(opt)) <span class="hljs-comment"># 输出所有训练参数</span><br>        check_git_status() <span class="hljs-comment"># 检查yolo v5的官方仓库状态</span><br>        check_requirements(ROOT / <span class="hljs-string">&quot;requirements.txt&quot;</span>)<br><br>    <span class="hljs-comment"># 是否进行断点续传</span><br>    <span class="hljs-comment"># 如果resume是True，则通过get_lastest_run()函数找到runs为文件夹中最近的权重文件last.pt</span><br>    <span class="hljs-keyword">if</span> opt.resume <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> check_comet_resume(opt) <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> opt.evolve:<br>        last = Path(check_file(opt.resume) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(opt.resume, <span class="hljs-built_in">str</span>) <span class="hljs-keyword">else</span> get_latest_run())<br>        opt_yaml = last.parent.parent / <span class="hljs-string">&quot;opt.yaml&quot;</span>  <span class="hljs-comment"># train options yaml</span><br>        opt_data = opt.data  <span class="hljs-comment"># original dataset</span><br>        <span class="hljs-keyword">if</span> opt_yaml.is_file():<br>            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(opt_yaml, errors=<span class="hljs-string">&quot;ignore&quot;</span>) <span class="hljs-keyword">as</span> f:<br>                d = yaml.safe_load(f)<br>        <span class="hljs-keyword">else</span>:<br>            d = torch.load(last, map_location=<span class="hljs-string">&quot;cpu&quot;</span>)[<span class="hljs-string">&quot;opt&quot;</span>]<br>        opt = argparse.Namespace(**d)  <span class="hljs-comment"># replace</span><br>        opt.cfg, opt.weights, opt.resume = <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-built_in">str</span>(last), <span class="hljs-literal">True</span>  <span class="hljs-comment"># reinstate</span><br>        <span class="hljs-keyword">if</span> is_url(opt_data):<br>            opt.data = check_file(opt_data)  <span class="hljs-comment"># avoid HUB resume auth timeout</span><br>    <span class="hljs-keyword">else</span>:<br>        opt.data, opt.cfg, opt.hyp, opt.weights, opt.project = (<br>            check_file(opt.data),<br>            check_yaml(opt.cfg),<br>            check_yaml(opt.hyp),<br>            <span class="hljs-built_in">str</span>(opt.weights),<br>            <span class="hljs-built_in">str</span>(opt.project),<br>        )  <span class="hljs-comment"># 如果模型文件和权重文件为空，弹出警告</span><br>        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(opt.cfg) <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(opt.weights), <span class="hljs-string">&quot;either --cfg or --weights must be specified&quot;</span><br>        <br>        <span class="hljs-comment"># 如果要进行超参数进化，重建保存路径</span><br>        <span class="hljs-keyword">if</span> opt.evolve:<br>        	<span class="hljs-comment"># 设置新的项目输出目录</span><br>            <span class="hljs-keyword">if</span> opt.project == <span class="hljs-built_in">str</span>(ROOT / <span class="hljs-string">&quot;runs/train&quot;</span>):  <span class="hljs-comment"># if default project name, rename to runs/evolve</span><br>                opt.project = <span class="hljs-built_in">str</span>(ROOT / <span class="hljs-string">&quot;runs/evolve&quot;</span>)<br>            <span class="hljs-comment"># 将resume传递给exist_ok</span><br>            opt.exist_ok, opt.resume = opt.resume, <span class="hljs-literal">False</span>  <span class="hljs-comment"># pass resume to exist_ok and disable resume</span><br>        <span class="hljs-keyword">if</span> opt.name == <span class="hljs-string">&quot;cfg&quot;</span>:<br>            opt.name = Path(opt.cfg).stem  <span class="hljs-comment"># use model.yaml as name</span><br>           <br>        <span class="hljs-comment"># 根据opt.project生成目录，并赋值给opt.save_dir  如: runs/train/exp1</span><br>        opt.save_dir = <span class="hljs-built_in">str</span>(increment_path(Path(opt.project) / opt.name, exist_ok=opt.exist_ok))<br></code></pre></td></tr></table></figure>

<p>分布式训练的判断部分：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 分布式训练 DDP mode</span><br>device = select_device(opt.device, batch_size=opt.batch_size)<br><span class="hljs-comment"># 当进程内的GPU编号不为-1时，才会进入DDP</span><br><span class="hljs-keyword">if</span> LOCAL_RANK != -<span class="hljs-number">1</span>:<br>    msg = <span class="hljs-string">&quot;is not compatible with YOLOv5 Multi-GPU DDP training&quot;</span><br>    <span class="hljs-keyword">assert</span> <span class="hljs-keyword">not</span> opt.image_weights, <span class="hljs-string">f&quot;--image-weights <span class="hljs-subst">&#123;msg&#125;</span>&quot;</span><br>    <span class="hljs-keyword">assert</span> <span class="hljs-keyword">not</span> opt.evolve, <span class="hljs-string">f&quot;--evolve <span class="hljs-subst">&#123;msg&#125;</span>&quot;</span><br>    <span class="hljs-keyword">assert</span> opt.batch_size != -<span class="hljs-number">1</span>, <span class="hljs-string">f&quot;AutoBatch with --batch-size -1 <span class="hljs-subst">&#123;msg&#125;</span>, please pass a valid --batch-size&quot;</span><br>    <span class="hljs-keyword">assert</span> opt.batch_size % WORLD_SIZE == <span class="hljs-number">0</span>, <span class="hljs-string">f&quot;--batch-size <span class="hljs-subst">&#123;opt.batch_size&#125;</span> must be multiple of WORLD_SIZE&quot;</span><br>    <span class="hljs-keyword">assert</span> torch.cuda.device_count() &gt; LOCAL_RANK, <span class="hljs-string">&quot;insufficient CUDA devices for DDP command&quot;</span><br>    torch.cuda.set_device(LOCAL_RANK)<br>    device = torch.device(<span class="hljs-string">&quot;cuda&quot;</span>, LOCAL_RANK)<br>    <br>    dist.init_process_group(<br>        backend=<span class="hljs-string">&quot;nccl&quot;</span> <span class="hljs-keyword">if</span> dist.is_nccl_available() <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;gloo&quot;</span>, timeout=timedelta(seconds=<span class="hljs-number">10800</span>)<br>    )<br></code></pre></td></tr></table></figure>

<p>进化训练的判断：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br></pre></td><td class="code"><pre><code class="hljs python">    <span class="hljs-comment"># 如果不进行超参数进化，则直接调用train()函数，开始训练</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> opt.evolve:<br>        train(opt.hyp, opt, device, callbacks)<br><br>    <span class="hljs-comment"># 是否进行进化训练/遗传算法调参</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-comment"># 超参数列表(突变范围 - 最小值 - 最大值)</span><br>        meta = &#123;<br>            <span class="hljs-string">&quot;lr0&quot;</span>: (<span class="hljs-literal">False</span>, <span class="hljs-number">1e-5</span>, <span class="hljs-number">1e-1</span>),  <span class="hljs-comment"># initial learning rate (SGD=1E-2, Adam=1E-3)</span><br>            <span class="hljs-string">&quot;lrf&quot;</span>: (<span class="hljs-literal">False</span>, <span class="hljs-number">0.01</span>, <span class="hljs-number">1.0</span>),  <span class="hljs-comment"># final OneCycleLR learning rate (lr0 * lrf)</span><br>            <span class="hljs-string">&quot;momentum&quot;</span>: (<span class="hljs-literal">False</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0.98</span>),  <span class="hljs-comment"># SGD momentum/Adam beta1</span><br>            <span class="hljs-string">&quot;weight_decay&quot;</span>: (<span class="hljs-literal">False</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.001</span>),  <span class="hljs-comment"># optimizer weight decay</span><br>            <span class="hljs-string">&quot;warmup_epochs&quot;</span>: (<span class="hljs-literal">False</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">5.0</span>),  <span class="hljs-comment"># warmup epochs (fractions ok)</span><br>            <span class="hljs-string">&quot;warmup_momentum&quot;</span>: (<span class="hljs-literal">False</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.95</span>),  <span class="hljs-comment"># warmup initial momentum</span><br>            <span class="hljs-string">&quot;warmup_bias_lr&quot;</span>: (<span class="hljs-literal">False</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.2</span>),  <span class="hljs-comment"># warmup initial bias lr</span><br>            <span class="hljs-string">&quot;box&quot;</span>: (<span class="hljs-literal">False</span>, <span class="hljs-number">0.02</span>, <span class="hljs-number">0.2</span>),  <span class="hljs-comment"># box loss gain</span><br>            <span class="hljs-string">&quot;cls&quot;</span>: (<span class="hljs-literal">False</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">4.0</span>),  <span class="hljs-comment"># cls loss gain</span><br>            <span class="hljs-string">&quot;cls_pw&quot;</span>: (<span class="hljs-literal">False</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">2.0</span>),  <span class="hljs-comment"># cls BCELoss positive_weight</span><br>            <span class="hljs-string">&quot;obj&quot;</span>: (<span class="hljs-literal">False</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">4.0</span>),  <span class="hljs-comment"># obj loss gain (scale with pixels)</span><br>            <span class="hljs-string">&quot;obj_pw&quot;</span>: (<span class="hljs-literal">False</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">2.0</span>),  <span class="hljs-comment"># obj BCELoss positive_weight</span><br>            <span class="hljs-string">&quot;iou_t&quot;</span>: (<span class="hljs-literal">False</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">0.7</span>),  <span class="hljs-comment"># IoU training threshold</span><br>            <span class="hljs-string">&quot;anchor_t&quot;</span>: (<span class="hljs-literal">False</span>, <span class="hljs-number">2.0</span>, <span class="hljs-number">8.0</span>),  <span class="hljs-comment"># anchor-multiple threshold</span><br>            <span class="hljs-string">&quot;anchors&quot;</span>: (<span class="hljs-literal">False</span>, <span class="hljs-number">2.0</span>, <span class="hljs-number">10.0</span>),  <span class="hljs-comment"># anchors per output grid (0 to ignore)</span><br>            <span class="hljs-string">&quot;fl_gamma&quot;</span>: (<span class="hljs-literal">False</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">2.0</span>),  <span class="hljs-comment"># focal loss gamma (efficientDet default gamma=1.5)</span><br>            <span class="hljs-string">&quot;hsv_h&quot;</span>: (<span class="hljs-literal">True</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.1</span>),  <span class="hljs-comment"># image HSV-Hue augmentation (fraction)</span><br>            <span class="hljs-string">&quot;hsv_s&quot;</span>: (<span class="hljs-literal">True</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.9</span>),  <span class="hljs-comment"># image HSV-Saturation augmentation (fraction)</span><br>            <span class="hljs-string">&quot;hsv_v&quot;</span>: (<span class="hljs-literal">True</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.9</span>),  <span class="hljs-comment"># image HSV-Value augmentation (fraction)</span><br>            <span class="hljs-string">&quot;degrees&quot;</span>: (<span class="hljs-literal">True</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">45.0</span>),  <span class="hljs-comment"># image rotation (+/- deg)</span><br>            <span class="hljs-string">&quot;translate&quot;</span>: (<span class="hljs-literal">True</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.9</span>),  <span class="hljs-comment"># image translation (+/- fraction)</span><br>            <span class="hljs-string">&quot;scale&quot;</span>: (<span class="hljs-literal">True</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.9</span>),  <span class="hljs-comment"># image scale (+/- gain)</span><br>            <span class="hljs-string">&quot;shear&quot;</span>: (<span class="hljs-literal">True</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">10.0</span>),  <span class="hljs-comment"># image shear (+/- deg)</span><br>            <span class="hljs-string">&quot;perspective&quot;</span>: (<span class="hljs-literal">True</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.001</span>),  <span class="hljs-comment"># image perspective (+/- fraction), range 0-0.001</span><br>            <span class="hljs-string">&quot;flipud&quot;</span>: (<span class="hljs-literal">True</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>),  <span class="hljs-comment"># image flip up-down (probability)</span><br>            <span class="hljs-string">&quot;fliplr&quot;</span>: (<span class="hljs-literal">True</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>),  <span class="hljs-comment"># image flip left-right (probability)</span><br>            <span class="hljs-string">&quot;mosaic&quot;</span>: (<span class="hljs-literal">True</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>),  <span class="hljs-comment"># image mixup (probability)</span><br>            <span class="hljs-string">&quot;mixup&quot;</span>: (<span class="hljs-literal">True</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>),  <span class="hljs-comment"># image mixup (probability)</span><br>            <span class="hljs-string">&quot;copy_paste&quot;</span>: (<span class="hljs-literal">True</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>),<br>        &#125;  <span class="hljs-comment"># segment copy-paste (probability)</span><br><br>        <span class="hljs-comment"># GA configs </span><br>        pop_size = <span class="hljs-number">50</span><br>        mutation_rate_min = <span class="hljs-number">0.01</span><br>        mutation_rate_max = <span class="hljs-number">0.5</span><br>        crossover_rate_min = <span class="hljs-number">0.5</span><br>        crossover_rate_max = <span class="hljs-number">1</span><br>        min_elite_size = <span class="hljs-number">2</span><br>        max_elite_size = <span class="hljs-number">5</span><br>        tournament_size_min = <span class="hljs-number">2</span><br>        tournament_size_max = <span class="hljs-number">10</span><br>		<br>        <span class="hljs-comment"># 加载默认超参数</span><br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(opt.hyp, errors=<span class="hljs-string">&quot;ignore&quot;</span>) <span class="hljs-keyword">as</span> f:<br>            hyp = yaml.safe_load(f)  <span class="hljs-comment"># load hyps dict</span><br>            <br>            <span class="hljs-comment"># 如果超参数文件中没有&#x27;anchors&#x27;，则设为3</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;anchors&quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> hyp:  <span class="hljs-comment"># anchors commented in hyp.yaml</span><br>                hyp[<span class="hljs-string">&quot;anchors&quot;</span>] = <span class="hljs-number">3</span><br>        <span class="hljs-keyword">if</span> opt.noautoanchor:<br>            <span class="hljs-keyword">del</span> hyp[<span class="hljs-string">&quot;anchors&quot;</span>], meta[<span class="hljs-string">&quot;anchors&quot;</span>]<br>            <br>        <span class="hljs-comment"># 使用进化算法时，仅在最后的epoch测试和保存</span><br>        opt.noval, opt.nosave, save_dir = <span class="hljs-literal">True</span>, <span class="hljs-literal">True</span>, Path(opt.save_dir)  <span class="hljs-comment"># only val/save final epoch</span><br>        <span class="hljs-comment"># ei = [isinstance(x, (int, float)) for x in hyp.values()]  # evolvable indices</span><br>        evolve_yaml, evolve_csv = save_dir / <span class="hljs-string">&quot;hyp_evolve.yaml&quot;</span>, save_dir / <span class="hljs-string">&quot;evolve.csv&quot;</span><br>        <span class="hljs-keyword">if</span> opt.bucket:<br>            <span class="hljs-comment"># download evolve.csv if exists</span><br>            subprocess.run(<br>                [<br>                    <span class="hljs-string">&quot;gsutil&quot;</span>,<br>                    <span class="hljs-string">&quot;cp&quot;</span>,<br>                    <span class="hljs-string">f&quot;gs://<span class="hljs-subst">&#123;opt.bucket&#125;</span>/evolve.csv&quot;</span>,<br>                    <span class="hljs-built_in">str</span>(evolve_csv),<br>                ]<br>            )<br><br>        <span class="hljs-comment"># Delete the items in meta dictionary whose first value is False</span><br>        del_ = [item <span class="hljs-keyword">for</span> item, value_ <span class="hljs-keyword">in</span> meta.items() <span class="hljs-keyword">if</span> value_[<span class="hljs-number">0</span>] <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>]<br>        hyp_GA = hyp.copy()  <span class="hljs-comment"># Make a copy of hyp dictionary</span><br>        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> del_:<br>            <span class="hljs-keyword">del</span> meta[item]  <span class="hljs-comment"># Remove the item from meta dictionary</span><br>            <span class="hljs-keyword">del</span> hyp_GA[item]  <span class="hljs-comment"># Remove the item from hyp_GA dictionary</span><br><br>        <span class="hljs-comment"># Set lower_limit and upper_limit arrays to hold the search space boundaries</span><br>        lower_limit = np.array([meta[k][<span class="hljs-number">1</span>] <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> hyp_GA.keys()])<br>        upper_limit = np.array([meta[k][<span class="hljs-number">2</span>] <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> hyp_GA.keys()])<br><br>        <span class="hljs-comment"># Create gene_ranges list to hold the range of values for each gene in the population</span><br>        gene_ranges = [(lower_limit[i], upper_limit[i]) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(upper_limit))]<br><br>        <span class="hljs-comment"># Initialize the population with initial_values or random values</span><br>        initial_values = []<br><br>        <span class="hljs-comment"># If resuming evolution from a previous checkpoint</span><br>        <span class="hljs-keyword">if</span> opt.resume_evolve <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">assert</span> os.path.isfile(ROOT / opt.resume_evolve), <span class="hljs-string">&quot;evolve population path is wrong!&quot;</span><br>            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(ROOT / opt.resume_evolve, errors=<span class="hljs-string">&quot;ignore&quot;</span>) <span class="hljs-keyword">as</span> f:<br>                evolve_population = yaml.safe_load(f)<br>                <span class="hljs-keyword">for</span> value <span class="hljs-keyword">in</span> evolve_population.values():<br>                    value = np.array([value[k] <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> hyp_GA.keys()])<br>                    initial_values.append(<span class="hljs-built_in">list</span>(value))<br><br>        <span class="hljs-comment"># If not resuming from a previous checkpoint, generate initial values from .yaml files in opt.evolve_population</span><br>        <span class="hljs-keyword">else</span>:<br>            yaml_files = [f <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> os.listdir(opt.evolve_population) <span class="hljs-keyword">if</span> f.endswith(<span class="hljs-string">&quot;.yaml&quot;</span>)]<br>            <span class="hljs-keyword">for</span> file_name <span class="hljs-keyword">in</span> yaml_files:<br>                <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(os.path.join(opt.evolve_population, file_name)) <span class="hljs-keyword">as</span> yaml_file:<br>                    value = yaml.safe_load(yaml_file)<br>                    value = np.array([value[k] <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> hyp_GA.keys()])<br>                    initial_values.append(<span class="hljs-built_in">list</span>(value))<br><br>        <span class="hljs-comment"># Generate random values within the search space for the rest of the population</span><br>        <span class="hljs-keyword">if</span> initial_values <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            population = [generate_individual(gene_ranges, <span class="hljs-built_in">len</span>(hyp_GA)) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(pop_size)]<br>        <span class="hljs-keyword">elif</span> pop_size &gt; <span class="hljs-number">1</span>:<br>            population = [generate_individual(gene_ranges, <span class="hljs-built_in">len</span>(hyp_GA)) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(pop_size - <span class="hljs-built_in">len</span>(initial_values))]<br>            <span class="hljs-keyword">for</span> initial_value <span class="hljs-keyword">in</span> initial_values:<br>                population = [initial_value] + population<br><br>        <span class="hljs-comment"># Run the genetic algorithm for a fixed number of generations</span><br>        list_keys = <span class="hljs-built_in">list</span>(hyp_GA.keys())<br>        <span class="hljs-keyword">for</span> generation <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(opt.evolve):<br>            <span class="hljs-keyword">if</span> generation &gt;= <span class="hljs-number">1</span>:<br>                save_dict = &#123;&#125;<br>                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(population)):<br>                    little_dict = &#123;list_keys[j]: <span class="hljs-built_in">float</span>(population[i][j]) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(population[i]))&#125;<br>                    save_dict[<span class="hljs-string">f&quot;gen<span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(generation)&#125;</span>number<span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(i)&#125;</span>&quot;</span>] = little_dict<br><br>                <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(save_dir / <span class="hljs-string">&quot;evolve_population.yaml&quot;</span>, <span class="hljs-string">&quot;w&quot;</span>) <span class="hljs-keyword">as</span> outfile:<br>                    yaml.dump(save_dict, outfile, default_flow_style=<span class="hljs-literal">False</span>)<br><br>            <span class="hljs-comment"># Adaptive elite size</span><br>            elite_size = min_elite_size + <span class="hljs-built_in">int</span>((max_elite_size - min_elite_size) * (generation / opt.evolve))<br>            <span class="hljs-comment"># Evaluate the fitness of each individual in the population</span><br>            fitness_scores = []<br>            <span class="hljs-keyword">for</span> individual <span class="hljs-keyword">in</span> population:<br>                <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(hyp_GA.keys(), individual):<br>                    hyp_GA[key] = value<br>                hyp.update(hyp_GA)<br>                results = train(hyp.copy(), opt, device, callbacks)<br>                callbacks = Callbacks()<br>                <span class="hljs-comment"># Write mutation results</span><br>                keys = (<br>                    <span class="hljs-string">&quot;metrics/precision&quot;</span>,<br>                    <span class="hljs-string">&quot;metrics/recall&quot;</span>,<br>                    <span class="hljs-string">&quot;metrics/mAP_0.5&quot;</span>,<br>                    <span class="hljs-string">&quot;metrics/mAP_0.5:0.95&quot;</span>,<br>                    <span class="hljs-string">&quot;val/box_loss&quot;</span>,<br>                    <span class="hljs-string">&quot;val/obj_loss&quot;</span>,<br>                    <span class="hljs-string">&quot;val/cls_loss&quot;</span>,<br>                )<br>                print_mutation(keys, results, hyp.copy(), save_dir, opt.bucket)<br>                fitness_scores.append(results[<span class="hljs-number">2</span>])<br><br>            <span class="hljs-comment"># Select the fittest individuals for reproduction using adaptive tournament selection</span><br>            selected_indices = []<br>            <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(pop_size - elite_size):<br>                <span class="hljs-comment"># Adaptive tournament size</span><br>                tournament_size = <span class="hljs-built_in">max</span>(<br>                    <span class="hljs-built_in">max</span>(<span class="hljs-number">2</span>, tournament_size_min),<br>                    <span class="hljs-built_in">int</span>(<span class="hljs-built_in">min</span>(tournament_size_max, pop_size) - (generation / (opt.evolve / <span class="hljs-number">10</span>))),<br>                )<br>                <span class="hljs-comment"># Perform tournament selection to choose the best individual</span><br>                tournament_indices = random.sample(<span class="hljs-built_in">range</span>(pop_size), tournament_size)<br>                tournament_fitness = [fitness_scores[j] <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> tournament_indices]<br>                winner_index = tournament_indices[tournament_fitness.index(<span class="hljs-built_in">max</span>(tournament_fitness))]<br>                selected_indices.append(winner_index)<br><br>            <span class="hljs-comment"># Add the elite individuals to the selected indices</span><br>            elite_indices = [i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(pop_size) <span class="hljs-keyword">if</span> fitness_scores[i] <span class="hljs-keyword">in</span> <span class="hljs-built_in">sorted</span>(fitness_scores)[-elite_size:]]<br>            selected_indices.extend(elite_indices)<br>            <span class="hljs-comment"># Create the next generation through crossover and mutation</span><br>            next_generation = []<br>            <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(pop_size):<br>                parent1_index = selected_indices[random.randint(<span class="hljs-number">0</span>, pop_size - <span class="hljs-number">1</span>)]<br>                parent2_index = selected_indices[random.randint(<span class="hljs-number">0</span>, pop_size - <span class="hljs-number">1</span>)]<br>                <span class="hljs-comment"># Adaptive crossover rate</span><br>                crossover_rate = <span class="hljs-built_in">max</span>(<br>                    crossover_rate_min, <span class="hljs-built_in">min</span>(crossover_rate_max, crossover_rate_max - (generation / opt.evolve))<br>                )<br>                <span class="hljs-keyword">if</span> random.uniform(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>) &lt; crossover_rate:<br>                    crossover_point = random.randint(<span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(hyp_GA) - <span class="hljs-number">1</span>)<br>                    child = population[parent1_index][:crossover_point] + population[parent2_index][crossover_point:]<br>                <span class="hljs-keyword">else</span>:<br>                    child = population[parent1_index]<br>                <span class="hljs-comment"># Adaptive mutation rate</span><br>                mutation_rate = <span class="hljs-built_in">max</span>(<br>                    mutation_rate_min, <span class="hljs-built_in">min</span>(mutation_rate_max, mutation_rate_max - (generation / opt.evolve))<br>                )<br>                <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(hyp_GA)):<br>                    <span class="hljs-keyword">if</span> random.uniform(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>) &lt; mutation_rate:<br>                        child[j] += random.uniform(-<span class="hljs-number">0.1</span>, <span class="hljs-number">0.1</span>)<br>                        child[j] = <span class="hljs-built_in">min</span>(<span class="hljs-built_in">max</span>(child[j], gene_ranges[j][<span class="hljs-number">0</span>]), gene_ranges[j][<span class="hljs-number">1</span>])<br>                next_generation.append(child)<br>            <span class="hljs-comment"># Replace the old population with the new generation</span><br>            population = next_generation<br>        <span class="hljs-comment"># Print the best solution found</span><br>        best_index = fitness_scores.index(<span class="hljs-built_in">max</span>(fitness_scores))<br>        best_individual = population[best_index]<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Best solution found:&quot;</span>, best_individual)<br>        <span class="hljs-comment"># Plot results 将结果可视化 / 输出保存信息</span><br>        plot_evolve(evolve_csv)<br>        LOGGER.info(<br>            <span class="hljs-string">f&#x27;Hyperparameter evolution finished <span class="hljs-subst">&#123;opt.evolve&#125;</span> generations\n&#x27;</span><br>            <span class="hljs-string">f&quot;Results saved to <span class="hljs-subst">&#123;colorstr(<span class="hljs-string">&#x27;bold&#x27;</span>, save_dir)&#125;</span>\n&quot;</span><br>            <span class="hljs-string">f&#x27;Usage example: $ python train.py --hyp <span class="hljs-subst">&#123;evolve_yaml&#125;</span>&#x27;</span><br>        )<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_individual</span>(<span class="hljs-params">input_ranges, individual_length</span>):<br>    individual = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(individual_length):<br>        lower_bound, upper_bound = input_ranges[i]<br>        individual.append(random.uniform(lower_bound, upper_bound))<br>    <span class="hljs-keyword">return</span> individual<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">**kwargs</span>):<br>    <span class="hljs-comment"># Usage: import train; train.run(data=&#x27;coco128.yaml&#x27;, imgsz=320, weights=&#x27;yolov5m.pt&#x27;)</span><br>    opt = parse_opt(<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> kwargs.items():<br>        <span class="hljs-comment"># setattr() 赋值属性，属性不存在则创建一个赋值</span><br>        <span class="hljs-built_in">setattr</span>(opt, k, v)<br>    main(opt)<br>    <span class="hljs-keyword">return</span> opt<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    opt = parse_opt()<br>    main(opt)<br><br></code></pre></td></tr></table></figure>

<p>2024&#x2F;4&#x2F;10 于苏州</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/CV/" class="category-chain-item">CV</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/CV/" class="print-no-link">#CV</a>
      
        <a href="/tags/%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/" class="print-no-link">#工程实践</a>
      
        <a href="/tags/Yolo/" class="print-no-link">#Yolo</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/04/05/Yolo-v5%E7%9A%84%E5%B7%A5%E7%A8%8B%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0%EF%BC%9A%E8%B6%85%E5%8F%82%E6%95%B0%E4%B8%8E%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5/" title="Yolo v5的工程代码实现：超参数与优化策略">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Yolo v5的工程代码实现：超参数与优化策略</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/04/02/%E9%97%AD%E5%8C%85%E4%B8%8E%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%EF%BC%9A%E6%B5%85%E8%96%84%E7%90%86%E8%A7%A3/" title="闭包与回调函数：浅薄理解">
                        <span class="hidden-mobile">闭包与回调函数：浅薄理解</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://cdn.jsdelivr.net/gh/HCLonely/Valine@latest/dist/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"wHpSTH8j8vF1pDJWJtnFXbzc-gzGzoHsz","appKey":"L2ZYyCM9mJIfR5Nxm7ktn3tU","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname,
            master: "",
            friends: "",
            tagMeta: ["博主","友人","访客"],
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
  
  <!-- 时间显示部分 -->
  <div>
    <span id="timeDate">载入天数...</span>
    <span id="times">载入时分秒...</span>
    <script>
      var now = new Date();
      function createtime(){
        var grt= new Date("12/27/2023 00:00:00");
        now.setTime(now.getTime()+250);
        days = (now - grt ) / 1000 / 60 / 60 / 24;
        dnum = Math.floor(days);
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum);
        hnum = Math.floor(hours);
        if(String(hnum).length ==1 ){
          hnum = "0" + hnum;
        }
        minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
        mnum = Math.floor(minutes);
        if(String(mnum).length ==1 ){
          mnum = "0" + mnum;
        }
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
        snum = Math.round(seconds);
        if(String(snum).length ==1 ){
          snum = "0" + snum;
        }
        document.getElementById("timeDate").innerHTML = "🚀 for&nbsp"+dnum+"&nbspdays";
        document.getElementById("times").innerHTML = hnum + "&nbsphr&nbsp" + mnum + "&nbspmin&nbsp" + snum + "&nbspsec";
      }
      setInterval("createtime()",250);
    </script>
  </div>
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
